<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>雷锋知识竞答</title>
  <style>
    :root{
      --card: rgba(255,255,255,.92);
      --shadow: 0 12px 40px rgba(0,0,0,.25);
      --brand: #d0021b;
      --gold: #d4af37;
      --text: #1a1a1a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      background: url("bg.jpg") center/cover no-repeat fixed;
    }
    .overlay{
      min-height:100vh;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .app{
      width:min(980px, 100%);
      background: var(--card);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      background: rgba(255,255,255,.95);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .logo{
      width:42px;height:42px;border-radius:10px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .titlewrap{flex:1}
    .title{
      font-size:18px;
      font-weight:800;
      line-height:1.2;
    }
    .subtitle{
      font-size:12px;
      opacity:.75;
      margin-top:2px;
    }
    .controls{
      display:flex;gap:8px;align-items:center;flex:0 0 auto;
    }
    .btn{
      border:0;
      background: var(--brand);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.secondary{
      background: rgba(0,0,0,.08);
      color:#111;
    }
    .btn.ghost{
      background: transparent;
      border:1px solid rgba(0,0,0,.18);
      color:#111;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .content{padding:16px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:14px;
      flex:1 1 300px;
    }
    .badgebar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .badge{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.8);
      font-size:13px;font-weight:700;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(0,0,0,.15);
    }
    .badge.on .dot{background: var(--gold)}
    .badge.on{border-color: rgba(212,175,55,.7)}
    .progress{
      height:10px;border-radius:999px;
      background: rgba(0,0,0,.08);
      overflow:hidden;
      margin-top:10px;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), #ff6a00);
      transition: width .25s ease;
    }
    .qtitle{
      font-size:16px;font-weight:800;line-height:1.35;
      margin:0 0 10px 0;
    }
    .meta{
      font-size:12px;opacity:.7;margin-bottom:10px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .options{display:grid;gap:10px}
    .opt{
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      cursor:pointer;
      display:flex;gap:10px;align-items:flex-start;
    }
    .opt:hover{background: rgba(0,0,0,.03)}
    .opt .k{
      font-weight:900;
      width:26px;height:26px;border-radius:8px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,.06);
      flex:0 0 auto;
    }
    .opt.correct{border-color: rgba(46,204,113,.55); background: rgba(46,204,113,.10)}
    .opt.wrong{border-color: rgba(231,76,60,.55); background: rgba(231,76,60,.10)}
    .footer{
      display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;
      margin-top:12px;
    }
    .hint{
      font-size:12px;opacity:.75;
    }
    .big{
      font-size:22px;font-weight:900;margin:4px 0 0;
    }
    .pill{
      display:inline-block;
      padding:6px 10px;border-radius:999px;
      background: rgba(208,2,27,.10);
      border:1px solid rgba(208,2,27,.25);
      font-weight:800;
      margin-right:8px;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;margin-top:10px;
    }
    input{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.18);
      font-size:14px;
    }
    .smallnote{font-size:12px;opacity:.75;margin-top:8px}
    @media (max-width:520px){
      .title{font-size:16px}
      .btn{padding:10px 10px}
    }
  </style>
</head>

<body>
<div class="overlay">
  <div class="app" id="app">
    <div class="topbar">
      <div class="logo"><img src="logo.png" alt="logo" onerror="this.style.display='none'"></div>
      <div class="titlewrap">
        <div class="title">雷锋知识竞答</div>
        <div class="subtitle" id="sub">三关闯关，集齐勋章，完成通关抽奖</div>
      </div>
      <div class="controls">
        <button class="btn ghost" id="musicBtn">♫ 音乐：关</button>
        <button class="btn secondary" id="resetBtn">重置</button>
      </div>
    </div>

    <div class="content" id="view"></div>
  </div>
</div>

<audio id="bgm" src="bgm.mp3" loop preload="auto"></audio>

<script>
/* -------------------------
   配置区：你可以自由改这些
------------------------- */
const PASS = {
  stage1_min_correct: 14, // 第一关 20 题，答对 >= 14 通过
  stage2_min_correct: 14, // 第二关 20 题
  stage3_min_correct: 13  // 第三关 19 题，建议按比例约 70%
};

// 三关标题 + 勋章名
const STAGES = [
  { key:"stage1", name:"第一关：雷锋基础知多少", level:"入门级", medal:"初心章" },
  { key:"stage2", name:"第二关：雷锋事迹大闯关", level:"进阶级", medal:"力行章" },
  { key:"stage3", name:"第三关：雷锋精神深领悟", level:"高阶级", medal:"传扬章" }
];

/* -------------------------
   题库：来自你的 PDF（共 59 题，缺少第56题）
   下面按 20 / 20 / 19 分配
------------------------- */

const Q_STAGE1 = [
  {"id":1,"q":"在鞍钢，雷锋几次被称为标兵？","options":{"A":"1次","B":"2次","C":"3次","D":"4次"},"answer":"C"},
  {"id":2,"q":"1963年1月7日，国防部命名雷锋生前所在的班为","options":{"A":"雷锋班","B":"模范班","C":"标兵班","D":"红旗班"},"answer":"A"},
  {"id":3,"q":"雷锋在什么地方出生？","options":{"A":"湖南省","B":"湖北省","C":"河南省","D":"河北省"},"answer":"A"},
  {"id":5,"q":"1960年11月23日，沈阳军区工程兵党委授予雷锋称号。","options":{"A":"先进工作者","B":"模范共青团员","C":"青年社会主义建设积极分子","D":"劳动模范"},"answer":"B"},
  {"id":6,"q":"由于他热心辅导少年先锋队，共青团中央特决定追认他为“全国优秀少先队辅导员”。请问是在决定的？","options":{"A":"1963年3月23日","B":"1964年3月23日","C":"1965年3月23日","D":"1960年1月18号"},"answer":"A"},
  {"id":8,"q":"雷锋精神又叫什么?","options":{"A":"共产主义精神","B":"集体主义精神","C":"爱国主义精神","D":"螺丝钉精神"},"answer":"D"},
  {"id":9,"q":"雷锋的日记一共多少篇？","options":{"A":"150篇","B":"152篇","C":"154篇","D":"156篇"},"answer":"B"},
  {"id":11,"q":"1963年3月5日，毛泽东题词","options":{"A":"向雷锋同志学习","B":"向雷锋学习","C":"学习雷锋好榜样","D":"雷锋精神永放光芒"},"answer":"A"},
  {"id":13,"q":"雷锋的出生日期是","options":{"A":"1940年12月18日","B":"1940年12月8日","C":"1940年12月28日","D":"1940年11月18日"},"answer":"A"},
  {"id":15,"q":"雷锋在部队当过什么？","options":{"A":"排长","B":"连长","C":"班长","D":"师长"},"answer":"C"},
  {"id":16,"q":"雷锋被评为“模范共青团员”的时间是","options":{"A":"1960年10月23日","B":"1960年11月23日","C":"1961年11月23日","D":"1962年11月23日"},"answer":"B"},
  {"id":18,"q":"全国第一个学习雷锋的积极分子、并被誉为“雷锋式战士”的是","options":{"A":"王杰","B":"郭明义","C":"焦裕禄","D":"赖宁"},"answer":"A"},
  {"id":19,"q":"“学习雷锋好榜样”这首歌是由谁作词？","options":{"A":"洪源","B":"郑南","C":"曹火星","D":"李劫夫"},"answer":"A"},
  {"id":21,"q":"雷锋在军队的职务是","options":{"A":"排长","B":"班长","C":"连长","D":"司机"},"answer":"D"},
  {"id":24,"q":"雷锋入伍后，所在的部队是","options":{"A":"沈阳军区工程兵某部","B":"北京军区某部","C":"广州军区某部","D":"南京军区某部"},"answer":"A"},
  {"id":28,"q":"雷锋的牺牲日期是","options":{"A":"1962年8月15日","B":"1963年8月15日","C":"1964年8月15日","D":"1961年8月15日"},"answer":"A"},
  {"id":30,"q":"“学雷锋纪念日”是每年的","options":{"A":"3月5日","B":"5月1日","C":"7月1日","D":"12月13日"},"answer":"A"},
  {"id":34,"q":"雷锋在部队参加的兵种是","options":{"A":"工程兵","B":"炮兵","C":"海军","D":"空军"},"answer":"A"},
  {"id":38,"q":"雷锋的籍贯是","options":{"A":"湖南长沙","B":"湖南湘潭","C":"湖南望城","D":"湖南衡阳"},"answer":"C"},
  {"id":43,"q":"雷锋牺牲时的年龄是","options":{"A":"20岁","B":"21岁","C":"22岁","D":"23岁"},"answer":"B"}
];

const Q_STAGE2 = [
  {"id":4,"q":"雷锋在鞍山和弓长岭焦化厂工作期间，曾18次被评为红旗手，并荣获的光荣称号。","options":{"A":"先进工作者","B":"模范共青团员","C":"共青团员标兵","D":"青年社会主义建设积极分子"},"answer":"D"},
  {"id":7,"q":"雷锋同志因何事而牺牲？","options":{"A":"交通事故","B":"救人牺牲","C":"疾病","D":"意外事故"},"answer":"B"},
  {"id":10,"q":"雷锋在工作中一贯保持艰苦奋斗的作风，他用省下来的钱做了许多好事，其中包括：为灾区捐款、帮助困难群众、支持社会主义建设等。下列哪项不属于他省钱做的好事？","options":{"A":"为灾区捐款","B":"帮助困难群众","C":"支持社会主义建设","D":"购买名贵手表"},"answer":"D"},
  {"id":14,"q":"雷锋入伍后驾驶的车辆是","options":{"A":"解放牌汽车","B":"东风牌汽车","C":"红旗牌汽车","D":"长江牌汽车"},"answer":"A"},
  {"id":17,"q":"雷锋曾在上写下“我要把有限的生命投入到无限的为人民服务之中去”。","options":{"A":"书信","B":"日记","C":"诗歌","D":"文章"},"answer":"B"},
  {"id":20,"q":"雷锋在鞍钢工作期间，曾被评为标兵","options":{"A":"1次","B":"2次","C":"3次","D":"4次"},"answer":"C"},
  {"id":22,"q":"雷锋在部队多次立功受奖，其中包括","options":{"A":"一次二等功","B":"两次三等功","C":"三次二等功","D":"四次一等功"},"answer":"B"},
  {"id":27,"q":"雷锋在部队加入中国共产党的时间是","options":{"A":"1960年11月8日","B":"1961年11月8日","C":"1962年11月8日","D":"1963年11月8日"},"answer":"B"},
  {"id":29,"q":"雷锋在鞍钢曾担任","options":{"A":"推土机手","B":"拖拉机手","C":"钢炉工","D":"煤矿工"},"answer":"A"},
  {"id":32,"q":"雷锋在鞍钢被评为“先进生产者”的次数是","options":{"A":"1次","B":"2次","C":"3次","D":"4次"},"answer":"B"},
  {"id":33,"q":"雷锋在鞍钢工作时，曾被评为“青年社会主义建设积极分子”的次数是","options":{"A":"1次","B":"2次","C":"3次","D":"4次"},"answer":"A"},
  {"id":41,"q":"雷锋在部队曾被授予“节约标兵”的称号。","options":{"A":"正确","B":"错误","C":"不确定","D":"以上都不是"},"answer":"A"},
  {"id":42,"q":"雷锋在鞍钢工作期间，曾被评为“红旗手”次。","options":{"A":"16","B":"17","C":"18","D":"19"},"answer":"C"},
  {"id":44,"q":"雷锋曾在火车上帮助一位大嫂找孩子，并把自己的座位让给她。","options":{"A":"正确","B":"错误","C":"不确定","D":"以上都不是"},"answer":"A"},
  {"id":45,"q":"雷锋曾在雨中护送一位老太太回家。","options":{"A":"正确","B":"错误","C":"不确定","D":"以上都不是"},"answer":"A"},
  {"id":49,"q":"雷锋曾向灾区捐款元。","options":{"A":"100","B":"200","C":"300","D":"400"},"answer":"A"},
  {"id":50,"q":"雷锋曾把自己省下的钱寄给战友的母亲。","options":{"A":"正确","B":"错误","C":"不确定","D":"以上都不是"},"answer":"A"},
  {"id":57,"q":"雷锋精神的核心是","options":{"A":"艰苦奋斗","B":"为人民服务","C":"爱岗敬业","D":"助人为乐"},"answer":"B"},
  {"id":58,"q":"“把有限的生命投入到无限的为人民服务之中去”出自雷锋的","options":{"A":"日记","B":"演讲","C":"小说","D":"报道"},"answer":"A"},
  {"id":60,"q":"雷锋在一次外出执行任务途中，下车帮助一位大娘，最后还把自己的钱给了她。","options":{"A":"正确","B":"错误","C":"不确定","D":"以上都不是"},"answer":"A"}
];

const Q_STAGE3 = [
  {"id":12,"q":"雷锋精神的实质是","options":{"A":"个人主义","B":"集体主义","C":"享乐主义","D":"拜金主义"},"answer":"B"},
  {"id":23,"q":"雷锋精神的时代内涵包括","options":{"A":"服务人民、助人为乐","B":"爱岗敬业、锐意进取","C":"艰苦奋斗、勤俭节约","D":"以上都是"},"answer":"D"},
  {"id":25,"q":"在新时代，学习雷锋更强调","options":{"A":"形式","B":"口号","C":"把精神转化为行动","D":"只做一次活动"},"answer":"C"},
  {"id":26,"q":"雷锋精神体现的价值取向是","options":{"A":"利己","B":"利他","C":"中立","D":"功利"},"answer":"B"},
  {"id":31,"q":"雷锋精神的精髓是","options":{"A":"忠于革命忠于党","B":"全心全意为人民服务","C":"刻苦学习","D":"勇于创新"},"answer":"B"},
  {"id":35,"q":"“一滴水只有放进大海里才永远不会干涸”强调的是","options":{"A":"个人与集体","B":"金钱的重要","C":"娱乐至上","D":"个人利益第一"},"answer":"A"},
  {"id":36,"q":"雷锋精神与志愿服务精神的关系是","options":{"A":"无关","B":"矛盾","C":"一脉相承","D":"完全相反"},"answer":"C"},
  {"id":37,"q":"学习雷锋最关键的是","options":{"A":"拍照打卡","B":"写心得","C":"长期坚持、融入日常","D":"只在纪念日做一次"},"answer":"C"},
  {"id":39,"q":"雷锋精神在当代最典型的体现之一是","options":{"A":"攀比","B":"志愿服务","C":"炫耀","D":"躺平"},"answer":"B"},
  {"id":40,"q":"雷锋精神倡导的工作态度更接近","options":{"A":"敷衍","B":"摆烂","C":"螺丝钉精神","D":"功利主义"},"answer":"C"},
  {"id":46,"q":"雷锋精神强调“助人为乐”，其根本出发点是","options":{"A":"获得回报","B":"全心全意为人民服务","C":"出名","D":"完成任务"},"answer":"B"},
  {"id":47,"q":"雷锋精神强调“爱岗敬业”，更接近下面哪种表达","options":{"A":"干一行爱一行","B":"只挑轻松的","C":"见利忘义","D":"得过且过"},"answer":"A"},
  {"id":48,"q":"雷锋精神强调“艰苦奋斗、勤俭节约”，反对的是","options":{"A":"勤俭","B":"奋斗","C":"铺张浪费","D":"节约"},"answer":"C"},
  {"id":51,"q":"学习雷锋需要把“精神”落实到","options":{"A":"口头","B":"行动","C":"形式","D":"宣传册"},"answer":"B"},
  {"id":52,"q":"雷锋精神具有鲜明的","options":{"A":"时代性","B":"人民性","C":"实践性","D":"以上都是"},"answer":"D"},
  {"id":53,"q":"雷锋精神对青少年的意义更突出在","options":{"A":"塑造价值观","B":"提高攀比能力","C":"强调享乐","D":"追求名利"},"answer":"A"},
  {"id":54,"q":"雷锋精神体现了社会主义核心价值观中的","options":{"A":"友善","B":"敬业","C":"奉献","D":"以上都是"},"answer":"D"},
  {"id":55,"q":"“学雷锋”最反对的做法是","options":{"A":"长期坚持","B":"日常化","C":"走过场","D":"立足岗位"},"answer":"C"},
  {"id":59,"q":"在新形势下涌现的以雷锋名字命名的先进集体和先进个人不计其数，其下就是雷锋精神的生动体现？","options":{"A":"红十字会","B":"希望工程","C":"扶贫工程","D":"青年志愿者行动"},"answer":"D"}
];

/* -------------------------
   状态管理
------------------------- */
const STORE_KEY = "lei_feng_quiz_v1";
const view = document.getElementById("view");
const sub = document.getElementById("sub");

let state = loadState() || {
  stageIndex: 0,
  qIndex: 0,
  correct: 0,
  wrong: 0,
  medals: { stage1:false, stage2:false, stage3:false },
  records: loadRecords(),
  musicOn: false,
  finished: false
};

function loadRecords(){
  try{
    const raw = localStorage.getItem(STORE_KEY+"_records");
    return raw ? JSON.parse(raw) : [];
  }catch{ return []; }
}
function saveRecords(){
  localStorage.setItem(STORE_KEY+"_records", JSON.stringify(state.records));
}
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function resetAll(){
  localStorage.removeItem(STORE_KEY);
  // records 也一起清掉，如你想保留记录就注释下一行
  // localStorage.removeItem(STORE_KEY+"_records");
  state = {
    stageIndex: 0, qIndex: 0, correct: 0, wrong: 0,
    medals: {stage1:false, stage2:false, stage3:false},
    records: loadRecords(),
    musicOn: false,
    finished:false
  };
  stopMusic();
  renderHome();
}
document.getElementById("resetBtn").addEventListener("click", resetAll);

/* -------------------------
   音乐控制
------------------------- */
const bgm = document.getElementById("bgm");
const musicBtn = document.getElementById("musicBtn");
function updateMusicBtn(){
  musicBtn.textContent = "♫ 音乐：" + (state.musicOn ? "开" : "关");
}
async function startMusic(){
  try{
    await bgm.play();
    state.musicOn = true;
    updateMusicBtn(); saveState();
  }catch(e){
    // 移动端若未交互会失败，等用户点击开始按钮时再试
  }
}
function stopMusic(){
  bgm.pause();
  bgm.currentTime = 0;
  state.musicOn = false;
  updateMusicBtn(); saveState();
}
musicBtn.addEventListener("click", async ()=>{
  if(state.musicOn){ stopMusic(); }
  else{ await startMusic(); }
});

/* -------------------------
   工具函数
------------------------- */
function stageQuestions(idx){
  if(idx===0) return Q_STAGE1;
  if(idx===1) return Q_STAGE2;
  return Q_STAGE3;
}
function stagePassMin(idx){
  if(idx===0) return PASS.stage1_min_correct;
  if(idx===1) return PASS.stage2_min_correct;
  return PASS.stage3_min_correct;
}
function stageKey(idx){ return STAGES[idx].key; }
function fmtNow(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function escapeCSV(s){
  const t = String(s ?? "");
  if(/[",\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
  return t;
}

/* -------------------------
   渲染：主页
------------------------- */
function renderHome(){
  sub.textContent = "三关闯关，集齐勋章，完成通关抽奖";
  const medals = state.medals;
  view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 520px">
        <div class="badgebar">
          ${badgeHTML("初心章", medals.stage1)}
          ${badgeHTML("力行章", medals.stage2)}
          ${badgeHTML("传扬章", medals.stage3)}
        </div>
        <div class="big" style="margin-top:10px">开始挑战</div>
        <div class="smallnote">规则：每关答题达到通关线才能进入下一关，否则本次挑战失败。</div>
        <div class="smallnote">提示：首次点击“开始”后，音乐才允许播放（浏览器限制）。</div>
        <div class="footer">
          <div class="hint">
            通关线：第一关 ≥ ${PASS.stage1_min_correct}/20，第二关 ≥ ${PASS.stage2_min_correct}/20，第三关 ≥ ${PASS.stage3_min_correct}/19
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="startBtn">开始</button>
            <button class="btn secondary" id="recordsBtn">查看通关名单</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">关卡</div>
        <div class="smallnote">${STAGES.map((s,i)=>`<div style="margin-top:6px"><span class="pill">第${i+1}关</span>${s.name}（${s.level}）</div>`).join("")}</div>
      </div>
    </div>
  `;
  document.getElementById("startBtn").addEventListener("click", async ()=>{
    // 用户交互后尝试播放音乐
    if(!state.musicOn) await startMusic();
    startNewRun();
  });
  document.getElementById("recordsBtn").addEventListener("click", renderRecords);
  updateMusicBtn();
}

function badgeHTML(name, on){
  return `<div class="badge ${on ? "on":""}"><div class="dot"></div>${name}</div>`;
}

/* -------------------------
   开始一轮新挑战（从第一关开始）
------------------------- */
function startNewRun(){
  state.stageIndex = 0;
  state.qIndex = 0;
  state.correct = 0;
  state.wrong = 0;
  state.medals = { stage1:false, stage2:false, stage3:false };
  state.finished = false;
  saveState();
  renderQuestion();
}

/* -------------------------
   渲染：答题页
------------------------- */
function renderQuestion(feedback){
  const sIdx = state.stageIndex;
  const stage = STAGES[sIdx];
  const qs = stageQuestions(sIdx);
  const q = qs[state.qIndex];

  sub.textContent = `${stage.name}（${stage.level}）`;

  const total = qs.length;
  const done = state.qIndex; // 已完成题数
  const pct = Math.round((done / total) * 100);

  view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 620px">
        <div class="badgebar">
          ${badgeHTML("初心章", state.medals.stage1)}
          ${badgeHTML("力行章", state.medals.stage2)}
          ${badgeHTML("传扬章", state.medals.stage3)}
        </div>
        <div class="progress"><div style="width:${pct}%"></div></div>

        <div class="meta">
          <div><b>题号</b>：${q.id}</div>
          <div><b>进度</b>：${state.qIndex+1}/${total}</div>
          <div><b>本关正确</b>：${state.correct}（通关线 ≥ ${stagePassMin(sIdx)}）</div>
        </div>

        <h3 class="qtitle">${q.q}</h3>

        <div class="options" id="opts">
          ${Object.entries(q.options).map(([k,v]) => `
            <div class="opt" data-k="${k}">
              <div class="k">${k}</div>
              <div>${v}</div>
            </div>
          `).join("")}
        </div>

        <div class="footer">
          <div class="hint" id="hint">${feedback ? feedback : "请选择一个答案"}</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn secondary" id="quitBtn">退出</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">当前战绩</div>
        <div class="smallnote" style="margin-top:10px">
          正确：<b>${state.correct}</b><br/>
          错误：<b>${state.wrong}</b><br/>
          本关剩余：<b>${total - (state.qIndex+1)}</b>
        </div>
        <div class="smallnote" style="margin-top:12px">
          规则：答完本关全部题后结算，达标才能进入下一关，不达标直接失败结束。
        </div>
      </div>
    </div>
  `;

  document.getElementById("quitBtn").addEventListener("click", ()=>{
    renderHome();
  });

  const opts = document.getElementById("opts");
  let locked = false;
  opts.querySelectorAll(".opt").forEach(el=>{
    el.addEventListener("click", ()=>{
      if(locked) return;
      locked = true;
      const chosen = el.getAttribute("data-k");
      const correct = q.answer;

      // 标记对错
      opts.querySelectorAll(".opt").forEach(o=>{
        const k = o.getAttribute("data-k");
        if(k === correct) o.classList.add("correct");
        if(k === chosen && chosen !== correct) o.classList.add("wrong");
        o.style.pointerEvents = "none";
      });

      if(chosen === correct) state.correct += 1;
      else state.wrong += 1;

      saveState();

      // 0.8 秒后进入下一题或结算
      setTimeout(()=>{
        nextStep();
      }, 800);
    });
  });
}

/* -------------------------
   下一步：下一题 or 结算
------------------------- */
function nextStep(){
  const sIdx = state.stageIndex;
  const qs = stageQuestions(sIdx);

  if(state.qIndex < qs.length - 1){
    state.qIndex += 1;
    saveState();
    renderQuestion();
    return;
  }

  // 本关答完，结算
  renderStageResult();
}

function renderStageResult(){
  const sIdx = state.stageIndex;
  const stage = STAGES[sIdx];
  const qs = stageQuestions(sIdx);
  const minCorrect = stagePassMin(sIdx);
  const passed = state.correct >= minCorrect;

  const total = qs.length;
  const scoreLine = `${state.correct}/${total}`;

  let msg = "";
  if(passed){
    state.medals[stageKey(sIdx)] = true;
    msg = `通过！获得【${stage.medal}】`;
  }else{
    msg = "未达标，本次挑战失败";
  }
  saveState();

  sub.textContent = "关卡结算";

  view.innerHTML = `
    <div class="card">
      <div class="badgebar" style="margin-bottom:10px">
        ${badgeHTML("初心章", state.medals.stage1)}
        ${badgeHTML("力行章", state.medals.stage2)}
        ${badgeHTML("传扬章", state.medals.stage3)}
      </div>

      <div class="big">${stage.name}</div>
      <div class="smallnote" style="margin-top:8px">
        成绩：<b>${scoreLine}</b>，通关线：<b>${minCorrect}</b>（答对题数）
      </div>

      <div class="big" style="color:${passed ? "var(--gold)" : "var(--brand)"}; margin-top:10px">${msg}</div>

      <div class="footer" style="margin-top:12px">
        <div class="hint">${passed ? "继续挑战下一关" : "你可以返回首页重新开始"}</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          ${passed ? `<button class="btn" id="nextStageBtn">进入下一关</button>` : ""}
          ${passed && sIdx === 2 ? `<button class="btn" id="finishBtn">填写通关信息</button>` : ""}
          <button class="btn secondary" id="homeBtn">返回首页</button>
          ${!passed ? `<button class="btn" id="retryBtn">重新挑战</button>` : ""}
        </div>
      </div>
    </div>
  `;

  document.getElementById("homeBtn").addEventListener("click", renderHome);

  const retry = document.getElementById("retryBtn");
  if(retry){
    retry.addEventListener("click", ()=>{
      // 重开本关
      state.qIndex = 0;
      state.correct = 0;
      state.wrong = 0;
      saveState();
      renderQuestion();
    });
  }

  const nextBtn = document.getElementById("nextStageBtn");
  if(nextBtn){
    nextBtn.addEventListener("click", ()=>{
      // 进入下一关，重置本关计数
      state.stageIndex += 1;
      state.qIndex = 0;
      state.correct = 0;
      state.wrong = 0;
      saveState();
      renderQuestion();
    });
  }

  const finishBtn = document.getElementById("finishBtn");
  if(finishBtn){
    finishBtn.addEventListener("click", renderFinishForm);
  }
}

function renderFinishForm(){
  sub.textContent = "完全通关";
  view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 520px">
        <div class="badgebar">
          ${badgeHTML("初心章", true)}
          ${badgeHTML("力行章", true)}
          ${badgeHTML("传扬章", true)}
        </div>
        <div class="big" style="margin-top:10px">恭喜完全通关！</div>
        <div class="smallnote">填写信息后将进入抽奖名单（记录保存在本浏览器，并可导出 CSV）。</div>

        <div class="field">
          <label>姓名</label>
          <input id="name" placeholder="请输入姓名" />
        </div>
        <div class="field">
          <label>手机号</label>
          <input id="phone" placeholder="请输入手机号" inputmode="numeric" />
        </div>

        <div class="footer">
          <div class="hint" id="formHint"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="submitBtn">提交</button>
            <button class="btn secondary" id="homeBtn2">返回首页</button>
          </div>
        </div>

        <div class="smallnote" style="margin-top:10px">
          如果你希望“自动汇总到表格”，可以把这里的提交改为调用你自己的 Webhook（比如 Google Apps Script）。
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">通关记录</div>
        <div class="smallnote" style="margin-top:10px">
          当前浏览器已保存：<b>${state.records.length}</b> 条记录
        </div>
        <div class="footer" style="margin-top:12px">
          <div class="hint">可直接导出给你抽奖</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn secondary" id="exportBtn">导出 CSV</button>
            <button class="btn ghost" id="recordsBtn2">查看名单</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("homeBtn2").addEventListener("click", renderHome);
  document.getElementById("exportBtn").addEventListener("click", exportCSV);
  document.getElementById("recordsBtn2").addEventListener("click", renderRecords);

  document.getElementById("submitBtn").addEventListener("click", ()=>{
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const hint = document.getElementById("formHint");

    if(!name){ hint.textContent = "请填写姓名"; return; }
    if(!/^1\\d{10}$/.test(phone)){ hint.textContent = "请填写正确的 11 位手机号"; return; }

    const rec = { name, phone, time: fmtNow() };
    state.records.unshift(rec);
    saveRecords();

    state.finished = true;
    saveState();

    hint.textContent = "已提交成功！";
    setTimeout(()=> renderHome(), 700);
  });
}

function renderRecords(){
  sub.textContent = "通关名单";
  const rows = state.records.slice(0, 200).map((r, idx)=>`
    <tr>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${idx+1}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.name}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.phone}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.time}</td>
    </tr>
  `).join("");

  view.innerHTML = `
    <div class="card">
      <div class="big">完全通关名单（本浏览器）</div>
      <div class="smallnote">条数：${state.records.length}（最多预览 200 条）</div>

      <div style="overflow:auto;margin-top:10px;border:1px solid rgba(0,0,0,.10);border-radius:12px">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="background:rgba(0,0,0,.04)">
              <th style="padding:8px;text-align:left">序号</th>
              <th style="padding:8px;text-align:left">姓名</th>
              <th style="padding:8px;text-align:left">手机号</th>
              <th style="padding:8px;text-align:left">时间</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="4" style="padding:10px">暂无记录</td></tr>`}</tbody>
        </table>
      </div>

      <div class="footer">
        <div class="hint">抽奖用：导出 CSV 后直接在表格里随机抽取</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn secondary" id="exportBtn2">导出 CSV</button>
          <button class="btn" id="homeBtn3">返回首页</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById("exportBtn2").addEventListener("click", exportCSV);
  document.getElementById("homeBtn3").addEventListener("click", renderHome);
}

function exportCSV(){
  const header = ["姓名","手机号","通关时间"];
  const lines = [header.join(",")].concat(
    state.records.map(r => [r.name, r.phone, r.time].map(escapeCSV).join(","))
  );
  const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "通关名单.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* -------------------------
   启动
------------------------- */
updateMusicBtn();
renderHome();
</script>
</body>
</html>