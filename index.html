<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>é›·é”‹çŸ¥è¯†ç«ç­”</title>
    <style>
        :root {
            --card: rgba(255, 255, 255, .92);
            --shadow: 0 12px 40px rgba(0, 0, 0, .25);
            --brand: #d0021b;
            --gold: #d4af37;
            --text: #1a1a1a;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
            color: var(--text);
            min-height: 100vh;
            background: url("bg.jpg") center/cover no-repeat fixed;
        }

        .overlay {
            min-height: 100vh;
            background: linear-gradient(180deg, rgba(0, 0, 0, .35), rgba(0, 0, 0, .55));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .app {
            width: min(980px, 100%);
            background: var(--card);
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, .95);
            border-bottom: 1px solid rgba(0, 0, 0, .06);
        }

        .logo {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, .08);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex: 0 0 auto;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: rotateLogo 8s linear infinite;
        }

        @keyframes rotateLogo {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .titlewrap {
            flex: 1
        }

        .title {
            font-size: 18px;
            font-weight: 800;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 12px;
            opacity: .75;
            margin-top: 2px;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 0 0 auto;
        }

        .btn {
            border: 0;
            background: var(--brand);
            color: #fff;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

        .btn.secondary {
            background: rgba(0, 0, 0, .08);
            color: #111;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, .18);
            color: #111;
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .content {
            padding: 16px
        }

        .row {
            display: flex;
            gap: 14px;
            flex-wrap: wrap
        }

        .card {
            background: #fff;
            border: 1px solid rgba(0, 0, 0, .08);
            border-radius: 16px;
            padding: 14px;
            flex: 1 1 300px;
        }

        .badgebar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, .10);
            background: rgba(255, 255, 255, .8);
            font-size: 13px;
            font-weight: 700;
        }

        .badge-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-icon.empty {
            border: 2px solid rgba(0, 0, 0, .15);
            border-radius: 4px;
            background: rgba(0, 0, 0, .03);
        }

        .badge-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .badge.on {
            border-color: rgba(212, 175, 55, .7)
        }

        .progress {
            height: 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .08);
            overflow: hidden;
            margin-top: 10px;
        }

        .progress>div {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--brand), #ff6a00);
            transition: width .25s ease;
        }

        .qtitle {
            font-size: 16px;
            font-weight: 800;
            line-height: 1.35;
            margin: 0 0 10px 0;
        }

        .meta {
            font-size: 12px;
            opacity: .7;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .options {
            display: grid;
            gap: 10px
        }

        .opt {
            border: 1px solid rgba(0, 0, 0, .12);
            border-radius: 12px;
            padding: 10px 12px;
            background: #fff;
            cursor: pointer;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .opt:hover {
            background: rgba(0, 0, 0, .03)
        }

        .opt .k {
            font-weight: 900;
            width: 26px;
            height: 26px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .06);
            flex: 0 0 auto;
        }

        .opt.correct {
            border-color: rgba(46, 204, 113, .55);
            background: rgba(46, 204, 113, .10)
        }

        .opt.wrong {
            border-color: rgba(231, 76, 60, .55);
            background: rgba(231, 76, 60, .10)
        }

        .footer {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .hint {
            font-size: 12px;
            opacity: .75;
        }

        .big {
            font-size: 22px;
            font-weight: 900;
            margin: 4px 0 0;
        }

        .pill {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(208, 2, 27, .10);
            border: 1px solid rgba(208, 2, 27, .25);
            font-weight: 800;
            margin-right: 8px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }

        input {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, .18);
            font-size: 14px;
        }

        .smallnote {
            font-size: 12px;
            opacity: .75;
            margin-top: 8px
        }

        @media (max-width:520px) {
            .title {
                font-size: 16px
            }

            .btn {
                padding: 10px 10px
            }
        }
    </style>
</head>

<body>
    <div class="overlay">
        <div class="app" id="app">
            <div class="topbar">
                <div class="logo"><img src="logo.png" alt="logo" onerror="this.style.display='none'"></div>
                <div class="titlewrap">
                    <div class="title">é›·é”‹çŸ¥è¯†ç«ç­”</div>
                    <div class="subtitle" id="sub">ä¸‰å…³é—¯å…³ï¼Œé›†é½å‹‹ç« ï¼Œå®Œæˆé€šå…³æŠ½å¥–</div>
                </div>
                <div class="controls">
                    <button class="btn ghost" id="musicBtn">â™« éŸ³ä¹ï¼šå…³</button>
                    <button class="btn secondary" id="resetBtn">é‡ç½®</button>
                </div>
            </div>

            <div class="content" id="view"></div>
        </div>
    </div>

    <audio id="bgm" src="bgm.mp3" loop preload="auto"></audio>

    <script>
        /* -------------------------
           é…ç½®åŒºï¼šä½ å¯ä»¥è‡ªç”±æ”¹è¿™äº›
        ------------------------- */
        const PASS = {
            stage1_min_correct: 8, // ç¬¬ä¸€å…³ 8 é¢˜
            stage2_min_correct: 8, // ç¬¬äºŒå…³ 8 é¢˜
            stage3_min_correct: 8  // ç¬¬ä¸‰å…³ 8 é¢˜
        };

        // çº¿ä¸Šä¿å­˜é…ç½®ï¼ˆå¯é€‰ï¼‰
        // æ–¹å¼1ï¼šä½¿ç”¨ Bmobï¼ˆæ¨èï¼Œå›½å†…å¯ç”¨ï¼Œå®Œå…¨å…è´¹ï¼‰
        // æ–¹å¼2ï¼šä½¿ç”¨ LeanCloudï¼ˆå·²åœæ­¢æ³¨å†Œæ–°è´¦å·ï¼‰
        // æ–¹å¼3ï¼šä½¿ç”¨ GitHub Gist APIï¼ˆéœ€è¦åˆ›å»º GitHub Personal Access Tokenï¼ŒToken ä¼šæ³„éœ²ï¼‰
        // 
        // Bmob é…ç½®æ­¥éª¤ï¼ˆæ¨èï¼‰ï¼š
        // 1. è®¿é—® https://www.bmob.cn æ³¨å†Œè´¦å·
        // 2. åˆ›å»ºåº”ç”¨ï¼ˆé€‰æ‹©"å…è´¹ç‰ˆ"ï¼‰
        // 3. åœ¨"è®¾ç½®" â†’ "åº”ç”¨å¯†é’¥"ä¸­è·å– Application ID å’Œ REST API Key
        // 4. åœ¨"æ•°æ®æœåŠ¡" â†’ "æ•°æ®æµè§ˆ"ä¸­åˆ›å»ºè¡¨ï¼šQuizResults
        // 5. å°† Application ID å’Œ REST API Key å¡«å…¥ä¸‹æ–¹é…ç½®
        // 
        // âš ï¸ æ³¨æ„ï¼šå¦‚æœä½¿ç”¨ GitHub Gistï¼Œä»£ç æ˜¯å…¬å¼€çš„ï¼Œtoken ä¼šè¢«æš´éœ²ã€‚
        const ONLINE_SAVE_CONFIG = {
            enabled: true, // è®¾ç½®ä¸º true å¯ç”¨çº¿ä¸Šä¿å­˜
            type: 'bmob', // 'bmob'ã€'leancloud'ã€'gist' æˆ– 'webhook'
            // Bmob é…ç½®ï¼ˆæ¨èï¼Œå›½å†…å¯ç”¨ï¼Œå…è´¹ï¼‰
            bmobApplicationId: '49324a15ae64d3b2ee4f8adb08716cc2', // Bmob Application ID
            bmobRestApiKey: 'c034c03d69c99c5185f19997ca1f32a5', // Bmob REST API Key
            // LeanCloud é…ç½®ï¼ˆå·²åœæ­¢æ³¨å†Œï¼‰
            leancloudAppId: '', // LeanCloud App ID
            leancloudAppKey: '', // LeanCloud App Key
            leancloudServerUrl: '', // æœåŠ¡å™¨åœ°å€ï¼ˆå¯é€‰ï¼Œä¼šè‡ªåŠ¨ä» App ID ç”Ÿæˆï¼‰
            // GitHub Gist é…ç½®ï¼ˆä¸æ¨èï¼ŒToken ä¼šæ³„éœ²ï¼‰
            gistToken: '', // GitHub Personal Access Tokenï¼ˆæ ¼å¼ï¼šghp_xxxxxxxxxxxxï¼‰
            gistId: '', // GitHub Gist IDï¼ˆ32ä½å­—ç¬¦ï¼Œä» Gist URL ä¸­è·å–ï¼‰
            // Webhook é…ç½®
            webhookUrl: '' // Webhook URLï¼ˆå¦‚ Google Apps Script Web App URLï¼‰
        };

        // ä¸‰å…³æ ‡é¢˜ + å‹‹ç« å
        const STAGES = [
            { key: "stage1", name: "ç¬¬ä¸€å…³ï¼šé›·é”‹åŸºç¡€çŸ¥å¤šå°‘", level: "å…¥é—¨çº§", medal: "åˆå¿ƒç« " },
            { key: "stage2", name: "ç¬¬äºŒå…³ï¼šé›·é”‹äº‹è¿¹å¤§é—¯å…³", level: "è¿›é˜¶çº§", medal: "åŠ›è¡Œç« " },
            { key: "stage3", name: "ç¬¬ä¸‰å…³ï¼šé›·é”‹ç²¾ç¥æ·±é¢†æ‚Ÿ", level: "é«˜é˜¶çº§", medal: "ä¼ æ‰¬ç« " }
        ];

        /* -------------------------
           é¢˜åº“ï¼šæ¥è‡ªä½ çš„ PDFï¼ˆå…± 59 é¢˜ï¼Œç¼ºå°‘ç¬¬56é¢˜ï¼‰
           ä¸‹é¢æŒ‰ 8 / 8 / 8 åˆ†é…
        ------------------------- */

        const Q_STAGE1 = [
            { "id": 1, "q": "åœ¨éé’¢ï¼Œé›·é”‹å‡ æ¬¡è¢«ç§°ä¸ºæ ‡å…µï¼Ÿ", "options": { "A": "1æ¬¡", "B": "2æ¬¡", "C": "3æ¬¡", "D": "4æ¬¡" }, "answer": "C" },
            { "id": 2, "q": "1963å¹´1æœˆ7æ—¥ï¼Œå›½é˜²éƒ¨å‘½åé›·é”‹ç”Ÿå‰æ‰€åœ¨çš„ç­ä¸º", "options": { "A": "é›·é”‹ç­", "B": "æ¨¡èŒƒç­", "C": "æ ‡å…µç­", "D": "çº¢æ——ç­" }, "answer": "A" },
            { "id": 3, "q": "é›·é”‹åœ¨ä»€ä¹ˆåœ°æ–¹å‡ºç”Ÿï¼Ÿ", "options": { "A": "æ¹–å—çœ", "B": "æ¹–åŒ—çœ", "C": "æ²³å—çœ", "D": "æ²³åŒ—çœ" }, "answer": "A" },
            { "id": 5, "q": "1960å¹´11æœˆ23æ—¥ï¼Œæ²ˆé˜³å†›åŒºå·¥ç¨‹å…µå…šå§”æˆäºˆé›·é”‹ç§°å·ã€‚", "options": { "A": "å…ˆè¿›å·¥ä½œè€…", "B": "æ¨¡èŒƒå…±é’å›¢å‘˜", "C": "é’å¹´ç¤¾ä¼šä¸»ä¹‰å»ºè®¾ç§¯æåˆ†å­", "D": "åŠ³åŠ¨æ¨¡èŒƒ" }, "answer": "B" },
            { "id": 6, "q": "ç”±äºä»–çƒ­å¿ƒè¾…å¯¼å°‘å¹´å…ˆé”‹é˜Ÿï¼Œå…±é’å›¢ä¸­å¤®ç‰¹å†³å®šè¿½è®¤ä»–ä¸ºâ€œå…¨å›½ä¼˜ç§€å°‘å…ˆé˜Ÿè¾…å¯¼å‘˜â€ã€‚è¯·é—®æ˜¯åœ¨å†³å®šçš„ï¼Ÿ", "options": { "A": "1963å¹´3æœˆ23æ—¥", "B": "1964å¹´3æœˆ23æ—¥", "C": "1965å¹´3æœˆ23æ—¥", "D": "1960å¹´1æœˆ18å·" }, "answer": "A" },
            { "id": 8, "q": "é›·é”‹ç²¾ç¥åˆå«ä»€ä¹ˆ?", "options": { "A": "å…±äº§ä¸»ä¹‰ç²¾ç¥", "B": "é›†ä½“ä¸»ä¹‰ç²¾ç¥", "C": "çˆ±å›½ä¸»ä¹‰ç²¾ç¥", "D": "èºä¸é’‰ç²¾ç¥" }, "answer": "D" },
            { "id": 9, "q": "é›·é”‹çš„æ—¥è®°ä¸€å…±å¤šå°‘ç¯‡ï¼Ÿ", "options": { "A": "150ç¯‡", "B": "152ç¯‡", "C": "154ç¯‡", "D": "156ç¯‡" }, "answer": "B" },
            { "id": 11, "q": "1963å¹´3æœˆ5æ—¥ï¼Œæ¯›æ³½ä¸œé¢˜è¯", "options": { "A": "å‘é›·é”‹åŒå¿—å­¦ä¹ ", "B": "å‘é›·é”‹å­¦ä¹ ", "C": "å­¦ä¹ é›·é”‹å¥½æ¦œæ ·", "D": "é›·é”‹ç²¾ç¥æ°¸æ”¾å…‰èŠ’" }, "answer": "A" },
            // { "id": 13, "q": "é›·é”‹çš„å‡ºç”Ÿæ—¥æœŸæ˜¯", "options": { "A": "1940å¹´12æœˆ18æ—¥", "B": "1940å¹´12æœˆ8æ—¥", "C": "1940å¹´12æœˆ28æ—¥", "D": "1940å¹´11æœˆ18æ—¥" }, "answer": "A" },
            // { "id": 15, "q": "é›·é”‹åœ¨éƒ¨é˜Ÿå½“è¿‡ä»€ä¹ˆï¼Ÿ", "options": { "A": "æ’é•¿", "B": "è¿é•¿", "C": "ç­é•¿", "D": "å¸ˆé•¿" }, "answer": "C" },
            // { "id": 16, "q": "é›·é”‹è¢«è¯„ä¸ºâ€œæ¨¡èŒƒå…±é’å›¢å‘˜â€çš„æ—¶é—´æ˜¯", "options": { "A": "1960å¹´10æœˆ23æ—¥", "B": "1960å¹´11æœˆ23æ—¥", "C": "1961å¹´11æœˆ23æ—¥", "D": "1962å¹´11æœˆ23æ—¥" }, "answer": "B" },
            // { "id": 18, "q": "å…¨å›½ç¬¬ä¸€ä¸ªå­¦ä¹ é›·é”‹çš„ç§¯æåˆ†å­ã€å¹¶è¢«èª‰ä¸ºâ€œé›·é”‹å¼æˆ˜å£«â€çš„æ˜¯", "options": { "A": "ç‹æ°", "B": "éƒ­æ˜ä¹‰", "C": "ç„¦è£•ç¦„", "D": "èµ–å®" }, "answer": "A" },
            // { "id": 19, "q": "â€œå­¦ä¹ é›·é”‹å¥½æ¦œæ ·â€è¿™é¦–æ­Œæ˜¯ç”±è°ä½œè¯ï¼Ÿ", "options": { "A": "æ´ªæº", "B": "éƒ‘å—", "C": "æ›¹ç«æ˜Ÿ", "D": "æåŠ«å¤«" }, "answer": "A" },
            // { "id": 21, "q": "é›·é”‹åœ¨å†›é˜Ÿçš„èŒåŠ¡æ˜¯", "options": { "A": "æ’é•¿", "B": "ç­é•¿", "C": "è¿é•¿", "D": "å¸æœº" }, "answer": "D" },
            // { "id": 24, "q": "é›·é”‹å…¥ä¼åï¼Œæ‰€åœ¨çš„éƒ¨é˜Ÿæ˜¯", "options": { "A": "æ²ˆé˜³å†›åŒºå·¥ç¨‹å…µæŸéƒ¨", "B": "åŒ—äº¬å†›åŒºæŸéƒ¨", "C": "å¹¿å·å†›åŒºæŸéƒ¨", "D": "å—äº¬å†›åŒºæŸéƒ¨" }, "answer": "A" },
            // { "id": 28, "q": "é›·é”‹çš„ç‰ºç‰²æ—¥æœŸæ˜¯", "options": { "A": "1962å¹´8æœˆ15æ—¥", "B": "1963å¹´8æœˆ15æ—¥", "C": "1964å¹´8æœˆ15æ—¥", "D": "1961å¹´8æœˆ15æ—¥" }, "answer": "A" },
            // { "id": 30, "q": "â€œå­¦é›·é”‹çºªå¿µæ—¥â€æ˜¯æ¯å¹´çš„", "options": { "A": "3æœˆ5æ—¥", "B": "5æœˆ1æ—¥", "C": "7æœˆ1æ—¥", "D": "12æœˆ13æ—¥" }, "answer": "A" },
            // { "id": 34, "q": "é›·é”‹åœ¨éƒ¨é˜Ÿå‚åŠ çš„å…µç§æ˜¯", "options": { "A": "å·¥ç¨‹å…µ", "B": "ç‚®å…µ", "C": "æµ·å†›", "D": "ç©ºå†›" }, "answer": "A" },
            // { "id": 38, "q": "é›·é”‹çš„ç±è´¯æ˜¯", "options": { "A": "æ¹–å—é•¿æ²™", "B": "æ¹–å—æ¹˜æ½­", "C": "æ¹–å—æœ›åŸ", "D": "æ¹–å—è¡¡é˜³" }, "answer": "C" },
            // { "id": 43, "q": "é›·é”‹ç‰ºç‰²æ—¶çš„å¹´é¾„æ˜¯", "options": { "A": "20å²", "B": "21å²", "C": "22å²", "D": "23å²" }, "answer": "B" }
        ];

        const Q_STAGE2 = [
            { "id": 4, "q": "é›·é”‹åœ¨éå±±å’Œå¼“é•¿å²­ç„¦åŒ–å‚å·¥ä½œæœŸé—´ï¼Œæ›¾18æ¬¡è¢«è¯„ä¸ºçº¢æ——æ‰‹ï¼Œå¹¶è£è·çš„å…‰è£ç§°å·ã€‚", "options": { "A": "å…ˆè¿›å·¥ä½œè€…", "B": "æ¨¡èŒƒå…±é’å›¢å‘˜", "C": "å…±é’å›¢å‘˜æ ‡å…µ", "D": "é’å¹´ç¤¾ä¼šä¸»ä¹‰å»ºè®¾ç§¯æåˆ†å­" }, "answer": "D" },
            { "id": 7, "q": "é›·é”‹åŒå¿—å› ä½•äº‹è€Œç‰ºç‰²ï¼Ÿ", "options": { "A": "äº¤é€šäº‹æ•…", "B": "æ•‘äººç‰ºç‰²", "C": "ç–¾ç—…", "D": "æ„å¤–äº‹æ•…" }, "answer": "A" },
            { "id": 10, "q": "é›·é”‹åœ¨å·¥ä½œä¸­ä¸€è´¯ä¿æŒè‰°è‹¦å¥‹æ–—çš„ä½œé£ï¼Œä»–ç”¨çœä¸‹æ¥çš„é’±åšäº†è®¸å¤šå¥½äº‹ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šä¸ºç¾åŒºææ¬¾ã€å¸®åŠ©å›°éš¾ç¾¤ä¼—ã€æ”¯æŒç¤¾ä¼šä¸»ä¹‰å»ºè®¾ç­‰ã€‚ä¸‹åˆ—å“ªé¡¹ä¸å±äºä»–çœé’±åšçš„å¥½äº‹ï¼Ÿ", "options": { "A": "ä¸ºç¾åŒºææ¬¾", "B": "å¸®åŠ©å›°éš¾ç¾¤ä¼—", "C": "æ”¯æŒç¤¾ä¼šä¸»ä¹‰å»ºè®¾", "D": "è´­ä¹°åè´µæ‰‹è¡¨" }, "answer": "D" },
            { "id": 14, "q": "é›·é”‹å…¥ä¼åé©¾é©¶çš„è½¦è¾†æ˜¯", "options": { "A": "è§£æ”¾ç‰Œæ±½è½¦", "B": "ä¸œé£ç‰Œæ±½è½¦", "C": "çº¢æ——ç‰Œæ±½è½¦", "D": "é•¿æ±Ÿç‰Œæ±½è½¦" }, "answer": "A" },
            { "id": 17, "q": "é›·é”‹æ›¾åœ¨ä¸Šå†™ä¸‹â€œæˆ‘è¦æŠŠæœ‰é™çš„ç”Ÿå‘½æŠ•å…¥åˆ°æ— é™çš„ä¸ºäººæ°‘æœåŠ¡ä¹‹ä¸­å»â€ã€‚", "options": { "A": "ä¹¦ä¿¡", "B": "æ—¥è®°", "C": "è¯—æ­Œ", "D": "æ–‡ç« " }, "answer": "B" },
            { "id": 20, "q": "é›·é”‹åœ¨éé’¢å·¥ä½œæœŸé—´ï¼Œæ›¾è¢«è¯„ä¸ºæ ‡å…µ", "options": { "A": "2æ¬¡", "B": "3æ¬¡", "C": "4æ¬¡", "D": "5æ¬¡" }, "answer": "D" },
            { "id": 22, "q": "é›·é”‹åœ¨éƒ¨é˜Ÿå¤šæ¬¡ç«‹åŠŸå—å¥–ï¼Œå…¶ä¸­åŒ…æ‹¬", "options": { "A": "ä¸€æ¬¡äºŒç­‰åŠŸ", "B": "ä¸¤æ¬¡ä¸‰ç­‰åŠŸ", "C": "ä¸‰æ¬¡äºŒç­‰åŠŸ", "D": "å››æ¬¡ä¸€ç­‰åŠŸ" }, "answer": "B" },
            { "id": 27, "q": "é›·é”‹åœ¨éƒ¨é˜ŸåŠ å…¥ä¸­å›½å…±äº§å…šçš„æ—¶é—´æ˜¯", "options": { "A": "1960å¹´11æœˆ8æ—¥", "B": "1961å¹´11æœˆ8æ—¥", "C": "1962å¹´11æœˆ8æ—¥", "D": "1963å¹´11æœˆ8æ—¥" }, "answer": "B" },
            // { "id": 29, "q": "é›·é”‹åœ¨éé’¢æ›¾æ‹…ä»»", "options": { "A": "æ¨åœŸæœºæ‰‹", "B": "æ‹–æ‹‰æœºæ‰‹", "C": "é’¢ç‚‰å·¥", "D": "ç…¤çŸ¿å·¥" }, "answer": "A" },
            // { "id": 32, "q": "é›·é”‹åœ¨éé’¢è¢«è¯„ä¸ºâ€œå…ˆè¿›ç”Ÿäº§è€…â€çš„æ¬¡æ•°æ˜¯", "options": { "A": "1æ¬¡", "B": "2æ¬¡", "C": "3æ¬¡", "D": "4æ¬¡" }, "answer": "B" },
            // { "id": 33, "q": "é›·é”‹åœ¨éé’¢å·¥ä½œæ—¶ï¼Œæ›¾è¢«è¯„ä¸ºâ€œé’å¹´ç¤¾ä¼šä¸»ä¹‰å»ºè®¾ç§¯æåˆ†å­â€çš„æ¬¡æ•°æ˜¯", "options": { "A": "1æ¬¡", "B": "2æ¬¡", "C": "3æ¬¡", "D": "4æ¬¡" }, "answer": "A" },
            // { "id": 41, "q": "é›·é”‹åœ¨éƒ¨é˜Ÿæ›¾è¢«æˆäºˆâ€œèŠ‚çº¦æ ‡å…µâ€çš„ç§°å·ã€‚", "options": { "A": "æ­£ç¡®", "B": "é”™è¯¯", "C": "ä¸ç¡®å®š", "D": "ä»¥ä¸Šéƒ½ä¸æ˜¯" }, "answer": "A" },
            // { "id": 42, "q": "é›·é”‹åœ¨éé’¢å·¥ä½œæœŸé—´ï¼Œæ›¾è¢«è¯„ä¸ºâ€œçº¢æ——æ‰‹â€æ¬¡ã€‚", "options": { "A": "16", "B": "17", "C": "18", "D": "19" }, "answer": "C" },
            // { "id": 44, "q": "é›·é”‹æ›¾åœ¨ç«è½¦ä¸Šå¸®åŠ©ä¸€ä½å¤§å«‚æ‰¾å­©å­ï¼Œå¹¶æŠŠè‡ªå·±çš„åº§ä½è®©ç»™å¥¹ã€‚", "options": { "A": "æ­£ç¡®", "B": "é”™è¯¯", "C": "ä¸ç¡®å®š", "D": "ä»¥ä¸Šéƒ½ä¸æ˜¯" }, "answer": "A" },
            // { "id": 45, "q": "é›·é”‹æ›¾åœ¨é›¨ä¸­æŠ¤é€ä¸€ä½è€å¤ªå¤ªå›å®¶ã€‚", "options": { "A": "æ­£ç¡®", "B": "é”™è¯¯", "C": "ä¸ç¡®å®š", "D": "ä»¥ä¸Šéƒ½ä¸æ˜¯" }, "answer": "A" },
            // { "id": 49, "q": "é›·é”‹æ›¾å‘ç¾åŒºææ¬¾å…ƒã€‚", "options": { "A": "100", "B": "200", "C": "300", "D": "400" }, "answer": "A" },
            // { "id": 50, "q": "é›·é”‹æ›¾æŠŠè‡ªå·±çœä¸‹çš„é’±å¯„ç»™æˆ˜å‹çš„æ¯äº²ã€‚", "options": { "A": "æ­£ç¡®", "B": "é”™è¯¯", "C": "ä¸ç¡®å®š", "D": "ä»¥ä¸Šéƒ½ä¸æ˜¯" }, "answer": "A" },
            // { "id": 57, "q": "é›·é”‹ç²¾ç¥çš„æ ¸å¿ƒæ˜¯", "options": { "A": "è‰°è‹¦å¥‹æ–—", "B": "ä¸ºäººæ°‘æœåŠ¡", "C": "çˆ±å²—æ•¬ä¸š", "D": "åŠ©äººä¸ºä¹" }, "answer": "B" },
            // { "id": 58, "q": "â€œæŠŠæœ‰é™çš„ç”Ÿå‘½æŠ•å…¥åˆ°æ— é™çš„ä¸ºäººæ°‘æœåŠ¡ä¹‹ä¸­å»â€å‡ºè‡ªé›·é”‹çš„", "options": { "A": "æ—¥è®°", "B": "æ¼”è®²", "C": "å°è¯´", "D": "æŠ¥é“" }, "answer": "A" },
            // { "id": 60, "q": "é›·é”‹åœ¨ä¸€æ¬¡å¤–å‡ºæ‰§è¡Œä»»åŠ¡é€”ä¸­ï¼Œä¸‹è½¦å¸®åŠ©ä¸€ä½å¤§å¨˜ï¼Œæœ€åè¿˜æŠŠè‡ªå·±çš„é’±ç»™äº†å¥¹ã€‚", "options": { "A": "æ­£ç¡®", "B": "é”™è¯¯", "C": "ä¸ç¡®å®š", "D": "ä»¥ä¸Šéƒ½ä¸æ˜¯" }, "answer": "A" }
        ];

        const Q_STAGE3 = [
            { "id": 12, "q": "é›·é”‹ç²¾ç¥çš„å®è´¨æ˜¯", "options": { "A": "ä¸ªäººä¸»ä¹‰", "B": "é›†ä½“ä¸»ä¹‰", "C": "äº«ä¹ä¸»ä¹‰", "D": "æ‹œé‡‘ä¸»ä¹‰" }, "answer": "B" },
            { "id": 23, "q": "é›·é”‹ç²¾ç¥çš„æ—¶ä»£å†…æ¶µåŒ…æ‹¬", "options": { "A": "æœåŠ¡äººæ°‘ã€åŠ©äººä¸ºä¹", "B": "çˆ±å²—æ•¬ä¸šã€é”æ„è¿›å–", "C": "è‰°è‹¦å¥‹æ–—ã€å‹¤ä¿­èŠ‚çº¦", "D": "ä»¥ä¸Šéƒ½æ˜¯" }, "answer": "D" },
            { "id": 25, "q": "åœ¨æ–°æ—¶ä»£ï¼Œå­¦ä¹ é›·é”‹æ›´å¼ºè°ƒ", "options": { "A": "å½¢å¼", "B": "å£å·", "C": "æŠŠç²¾ç¥è½¬åŒ–ä¸ºè¡ŒåŠ¨", "D": "åªåšä¸€æ¬¡æ´»åŠ¨" }, "answer": "C" },
            { "id": 26, "q": "é›·é”‹ç²¾ç¥ä½“ç°çš„ä»·å€¼å–å‘æ˜¯", "options": { "A": "åˆ©å·±", "B": "åˆ©ä»–", "C": "ä¸­ç«‹", "D": "åŠŸåˆ©" }, "answer": "B" },
            { "id": 31, "q": "é›·é”‹ç²¾ç¥çš„ç²¾é«“æ˜¯", "options": { "A": "å¿ äºé©å‘½å¿ äºå…š", "B": "å…¨å¿ƒå…¨æ„ä¸ºäººæ°‘æœåŠ¡", "C": "åˆ»è‹¦å­¦ä¹ ", "D": "å‹‡äºåˆ›æ–°" }, "answer": "B" },
            { "id": 35, "q": "â€œä¸€æ»´æ°´åªæœ‰æ”¾è¿›å¤§æµ·é‡Œæ‰æ°¸è¿œä¸ä¼šå¹²æ¶¸â€å¼ºè°ƒçš„æ˜¯", "options": { "A": "ä¸ªäººä¸é›†ä½“", "B": "é‡‘é’±çš„é‡è¦", "C": "å¨±ä¹è‡³ä¸Š", "D": "ä¸ªäººåˆ©ç›Šç¬¬ä¸€" }, "answer": "A" },
            { "id": 36, "q": "é›·é”‹ç²¾ç¥ä¸å¿—æ„¿æœåŠ¡ç²¾ç¥çš„å…³ç³»æ˜¯", "options": { "A": "æ— å…³", "B": "çŸ›ç›¾", "C": "ä¸€è„‰ç›¸æ‰¿", "D": "å®Œå…¨ç›¸å" }, "answer": "C" },
            { "id": 37, "q": "å­¦ä¹ é›·é”‹æœ€å…³é”®çš„æ˜¯", "options": { "A": "æ‹ç…§æ‰“å¡", "B": "å†™å¿ƒå¾—", "C": "é•¿æœŸåšæŒã€èå…¥æ—¥å¸¸", "D": "åªåœ¨çºªå¿µæ—¥åšä¸€æ¬¡" }, "answer": "C" },
            // { "id": 39, "q": "é›·é”‹ç²¾ç¥åœ¨å½“ä»£æœ€å…¸å‹çš„ä½“ç°ä¹‹ä¸€æ˜¯", "options": { "A": "æ”€æ¯”", "B": "å¿—æ„¿æœåŠ¡", "C": "ç‚«è€€", "D": "èººå¹³" }, "answer": "B" },
            // { "id": 40, "q": "é›·é”‹ç²¾ç¥å€¡å¯¼çš„å·¥ä½œæ€åº¦æ›´æ¥è¿‘", "options": { "A": "æ•·è¡", "B": "æ‘†çƒ‚", "C": "èºä¸é’‰ç²¾ç¥", "D": "åŠŸåˆ©ä¸»ä¹‰" }, "answer": "C" },
            // { "id": 46, "q": "é›·é”‹ç²¾ç¥å¼ºè°ƒâ€œåŠ©äººä¸ºä¹â€ï¼Œå…¶æ ¹æœ¬å‡ºå‘ç‚¹æ˜¯", "options": { "A": "è·å¾—å›æŠ¥", "B": "å…¨å¿ƒå…¨æ„ä¸ºäººæ°‘æœåŠ¡", "C": "å‡ºå", "D": "å®Œæˆä»»åŠ¡" }, "answer": "B" },
            // { "id": 47, "q": "é›·é”‹ç²¾ç¥å¼ºè°ƒâ€œçˆ±å²—æ•¬ä¸šâ€ï¼Œæ›´æ¥è¿‘ä¸‹é¢å“ªç§è¡¨è¾¾", "options": { "A": "å¹²ä¸€è¡Œçˆ±ä¸€è¡Œ", "B": "åªæŒ‘è½»æ¾çš„", "C": "è§åˆ©å¿˜ä¹‰", "D": "å¾—è¿‡ä¸”è¿‡" }, "answer": "A" },
            // { "id": 48, "q": "é›·é”‹ç²¾ç¥å¼ºè°ƒâ€œè‰°è‹¦å¥‹æ–—ã€å‹¤ä¿­èŠ‚çº¦â€ï¼Œåå¯¹çš„æ˜¯", "options": { "A": "å‹¤ä¿­", "B": "å¥‹æ–—", "C": "é“ºå¼ æµªè´¹", "D": "èŠ‚çº¦" }, "answer": "C" },
            // { "id": 51, "q": "å­¦ä¹ é›·é”‹éœ€è¦æŠŠâ€œç²¾ç¥â€è½å®åˆ°", "options": { "A": "å£å¤´", "B": "è¡ŒåŠ¨", "C": "å½¢å¼", "D": "å®£ä¼ å†Œ" }, "answer": "B" },
            // { "id": 52, "q": "é›·é”‹ç²¾ç¥å…·æœ‰é²œæ˜çš„", "options": { "A": "æ—¶ä»£æ€§", "B": "äººæ°‘æ€§", "C": "å®è·µæ€§", "D": "ä»¥ä¸Šéƒ½æ˜¯" }, "answer": "D" },
            // { "id": 53, "q": "é›·é”‹ç²¾ç¥å¯¹é’å°‘å¹´çš„æ„ä¹‰æ›´çªå‡ºåœ¨", "options": { "A": "å¡‘é€ ä»·å€¼è§‚", "B": "æé«˜æ”€æ¯”èƒ½åŠ›", "C": "å¼ºè°ƒäº«ä¹", "D": "è¿½æ±‚ååˆ©" }, "answer": "A" },
            // { "id": 54, "q": "é›·é”‹ç²¾ç¥ä½“ç°äº†ç¤¾ä¼šä¸»ä¹‰æ ¸å¿ƒä»·å€¼è§‚ä¸­çš„", "options": { "A": "å‹å–„", "B": "æ•¬ä¸š", "C": "å¥‰çŒ®", "D": "ä»¥ä¸Šéƒ½æ˜¯" }, "answer": "D" },
            // { "id": 55, "q": "â€œå­¦é›·é”‹â€æœ€åå¯¹çš„åšæ³•æ˜¯", "options": { "A": "é•¿æœŸåšæŒ", "B": "æ—¥å¸¸åŒ–", "C": "èµ°è¿‡åœº", "D": "ç«‹è¶³å²—ä½" }, "answer": "C" },
            // { "id": 59, "q": "åœ¨æ–°å½¢åŠ¿ä¸‹æ¶Œç°çš„ä»¥é›·é”‹åå­—å‘½åçš„å…ˆè¿›é›†ä½“å’Œå…ˆè¿›ä¸ªäººä¸è®¡å…¶æ•°ï¼Œå…¶ä¸‹å°±æ˜¯é›·é”‹ç²¾ç¥çš„ç”ŸåŠ¨ä½“ç°ï¼Ÿ", "options": { "A": "çº¢åå­—ä¼š", "B": "å¸Œæœ›å·¥ç¨‹", "C": "æ‰¶è´«å·¥ç¨‹", "D": "é’å¹´å¿—æ„¿è€…è¡ŒåŠ¨" }, "answer": "D" }
        ];

        /* -------------------------
           çŠ¶æ€ç®¡ç†
        ------------------------- */
        const STORE_KEY = "lei_feng_quiz_v1";
        const view = document.getElementById("view");
        const sub = document.getElementById("sub");

        let state = loadState() || {
            studentId: "",
            stageIndex: 0,
            qIndex: 0,
            correct: 0,
            wrong: 0,
            medals: { stage1: false, stage2: false, stage3: false },
            records: loadRecords(),
            musicOn: false,
            finished: false,
            stageResults: [] // è®°å½•æ¯å…³çš„ç­”é¢˜ç»“æœ
        };

        function loadRecords() {
            try {
                const raw = localStorage.getItem(STORE_KEY + "_records");
                return raw ? JSON.parse(raw) : [];
            } catch { return []; }
        }
        function saveRecords() {
            localStorage.setItem(STORE_KEY + "_records", JSON.stringify(state.records));
        }
        function saveState() {
            localStorage.setItem(STORE_KEY, JSON.stringify(state));
        }
        function loadState() {
            try {
                const raw = localStorage.getItem(STORE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch { return null; }
        }
        function resetAll() {
            localStorage.removeItem(STORE_KEY);
            // records ä¹Ÿä¸€èµ·æ¸…æ‰ï¼Œå¦‚ä½ æƒ³ä¿ç•™è®°å½•å°±æ³¨é‡Šä¸‹ä¸€è¡Œ
            // localStorage.removeItem(STORE_KEY+"_records");
            state = {
                studentId: "",
                stageIndex: 0, qIndex: 0, correct: 0, wrong: 0,
                medals: { stage1: false, stage2: false, stage3: false },
                records: loadRecords(),
                musicOn: false,
                finished: false,
                stageResults: []
            };
            stopMusic();
            renderHome();
        }
        document.getElementById("resetBtn").addEventListener("click", resetAll);

        /* -------------------------
           éŸ³ä¹æ§åˆ¶
        ------------------------- */
        const bgm = document.getElementById("bgm");
        const musicBtn = document.getElementById("musicBtn");
        function updateMusicBtn() {
            musicBtn.textContent = "â™« éŸ³ä¹ï¼š" + (state.musicOn ? "å¼€" : "å…³");
        }
        async function startMusic() {
            try {
                await bgm.play();
                state.musicOn = true;
                updateMusicBtn(); saveState();
            } catch (e) {
                // ç§»åŠ¨ç«¯è‹¥æœªäº¤äº’ä¼šå¤±è´¥ï¼Œç­‰ç”¨æˆ·ç‚¹å‡»å¼€å§‹æŒ‰é’®æ—¶å†è¯•
            }
        }
        function stopMusic() {
            bgm.pause();
            bgm.currentTime = 0;
            state.musicOn = false;
            updateMusicBtn(); saveState();
        }
        musicBtn.addEventListener("click", async () => {
            if (state.musicOn) { stopMusic(); }
            else { await startMusic(); }
        });

        /* -------------------------
           å·¥å…·å‡½æ•°
        ------------------------- */
        function stageQuestions(idx) {
            if (idx === 0) return Q_STAGE1;
            if (idx === 1) return Q_STAGE2;
            return Q_STAGE3;
        }
        function stagePassMin(idx) {
            if (idx === 0) return PASS.stage1_min_correct;
            if (idx === 1) return PASS.stage2_min_correct;
            return PASS.stage3_min_correct;
        }
        function stageKey(idx) { return STAGES[idx].key; }
        function fmtNow() {
            const d = new Date();
            const pad = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        function escapeCSV(s) {
            const t = String(s ?? "");
            if (/[",\n]/.test(t)) return `"${t.replace(/"/g, '""')}"`;
            return t;
        }

        /* -------------------------
           æ¸²æŸ“ï¼šä¸»é¡µ
        ------------------------- */
        function renderHome() {
            sub.textContent = "ä¸‰å…³é—¯å…³ï¼Œé›†é½å‹‹ç« ï¼Œå®Œæˆé€šå…³æŠ½å¥–";
            const medals = state.medals;

            // å¦‚æœå·²æœ‰å­¦å·ï¼Œæ˜¾ç¤ºå­¦å·ä¿¡æ¯ï¼›å¦åˆ™æ˜¾ç¤ºè¾“å…¥è¡¨å•
            const studentIdSection = state.studentId
                ? `<div class="smallnote" style="margin-top:10px;padding:10px;background:rgba(0,0,0,.04);border-radius:8px">
                    <b>å­¦å·ï¼š</b>${state.studentId}
                    <button class="btn ghost" id="changeStudentIdBtn" style="margin-left:10px;padding:6px 10px;font-size:12px">ä¿®æ”¹</button>
                   </div>`
                : `<div class="field" style="margin-top:10px">
                    <label><b>å­¦å·</b>ï¼ˆå¿…å¡«ï¼‰</label>
                    <input id="studentIdInput" placeholder="è¯·è¾“å…¥å­¦å·" />
                    <div class="smallnote">è¯·å¡«å†™æ‚¨çš„å­¦å·ï¼Œç”¨äºç»Ÿè®¡ç­”é¢˜ç»“æœ</div>
                  </div>`;

            view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 520px">
        <div class="badgebar">
          ${badgeHTML("åˆå¿ƒç« ", medals.stage1)}
          ${badgeHTML("åŠ›è¡Œç« ", medals.stage2)}
          ${badgeHTML("ä¼ æ‰¬ç« ", medals.stage3)}
        </div>
        <div class="big" style="margin-top:10px">å¼€å§‹æŒ‘æˆ˜</div>
        <div class="smallnote">è§„åˆ™ï¼šæ¯å…³ç­”é¢˜è¾¾åˆ°é€šå…³çº¿æ‰èƒ½è¿›å…¥ä¸‹ä¸€å…³ï¼Œå¦åˆ™æœ¬æ¬¡æŒ‘æˆ˜å¤±è´¥ã€‚</div>
        <div class="smallnote">æç¤ºï¼šé¦–æ¬¡ç‚¹å‡»"å¼€å§‹"åï¼ŒéŸ³ä¹æ‰å…è®¸æ’­æ”¾ï¼ˆæµè§ˆå™¨é™åˆ¶ï¼‰ã€‚</div>
        
        ${studentIdSection}
        
        <div class="footer" style="margin-top:12px">
          <div class="hint">
            é€šå…³çº¿ï¼šç¬¬ä¸€å…³ â‰¥ ${PASS.stage1_min_correct}/8ï¼Œç¬¬äºŒå…³ â‰¥ ${PASS.stage2_min_correct}/8ï¼Œç¬¬ä¸‰å…³ â‰¥ ${PASS.stage3_min_correct}/8
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="startBtn">å¼€å§‹</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">å…³å¡</div>
        <div class="smallnote">${STAGES.map((s, i) => `<div style="margin-top:6px"><span class="pill">ç¬¬${i + 1}å…³</span>${s.name}ï¼ˆ${s.level}ï¼‰</div>`).join("")}</div>
      </div>
    </div>
  `;

            const startBtn = document.getElementById("startBtn");
            startBtn.addEventListener("click", async () => {
                // æ£€æŸ¥å­¦å·
                if (!state.studentId) {
                    const input = document.getElementById("studentIdInput");
                    if (input) {
                        const id = input.value.trim();
                        if (!id) {
                            alert("è¯·å…ˆå¡«å†™å­¦å·ï¼");
                            return;
                        }
                        state.studentId = id;
                        saveState();
                    } else {
                        alert("è¯·å…ˆå¡«å†™å­¦å·ï¼");
                        return;
                    }
                }

                // ç”¨æˆ·äº¤äº’åå°è¯•æ’­æ”¾éŸ³ä¹
                if (!state.musicOn) await startMusic();
                startNewRun();
            });

            const changeBtn = document.getElementById("changeStudentIdBtn");
            if (changeBtn) {
                changeBtn.addEventListener("click", () => {
                    state.studentId = "";
                    saveState();
                    renderHome();
                });
            }

            updateMusicBtn();
        }

        function badgeHTML(name, on) {
            const iconHTML = on
                ? `<div class="badge-icon"><img src="medal.png" alt="${name}" onerror="this.parentElement.classList.add('empty')"></div>`
                : `<div class="badge-icon empty"></div>`;
            return `<div class="badge ${on ? "on" : ""}">${iconHTML}${name}</div>`;
        }

        /* -------------------------
           å¼€å§‹ä¸€è½®æ–°æŒ‘æˆ˜ï¼ˆä»ç¬¬ä¸€å…³å¼€å§‹ï¼‰
        ------------------------- */
        function startNewRun() {
            if (!state.studentId) {
                alert("è¯·å…ˆå¡«å†™å­¦å·ï¼");
                renderHome();
                return;
            }
            state.stageIndex = 0;
            state.qIndex = 0;
            state.correct = 0;
            state.wrong = 0;
            state.medals = { stage1: false, stage2: false, stage3: false };
            state.finished = false;
            state.stageResults = []; // é‡ç½®ç­”é¢˜ç»“æœ
            saveState();
            renderQuestion();
        }

        /* -------------------------
           æ¸²æŸ“ï¼šç­”é¢˜é¡µ
        ------------------------- */
        function renderQuestion(feedback) {
            const sIdx = state.stageIndex;
            const stage = STAGES[sIdx];
            const qs = stageQuestions(sIdx);
            const q = qs[state.qIndex];

            sub.textContent = `${stage.name}ï¼ˆ${stage.level}ï¼‰`;

            const total = qs.length;
            const done = state.qIndex; // å·²å®Œæˆé¢˜æ•°
            const pct = Math.round((done / total) * 100);

            view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 620px">
        <div class="badgebar">
          ${badgeHTML("åˆå¿ƒç« ", state.medals.stage1)}
          ${badgeHTML("åŠ›è¡Œç« ", state.medals.stage2)}
          ${badgeHTML("ä¼ æ‰¬ç« ", state.medals.stage3)}
        </div>
        <div class="progress"><div style="width:${pct}%"></div></div>

        <div class="meta">
          <div><b>é¢˜å·</b>ï¼š${q.id}</div>
          <div><b>è¿›åº¦</b>ï¼š${state.qIndex + 1}/${total}</div>
          <div><b>æœ¬å…³æ­£ç¡®</b>ï¼š${state.correct}ï¼ˆé€šå…³çº¿ â‰¥ ${stagePassMin(sIdx)}ï¼‰</div>
        </div>

        <h3 class="qtitle">${q.q}</h3>

        <div class="options" id="opts">
          ${Object.entries(q.options).map(([k, v]) => `
            <div class="opt" data-k="${k}">
              <div class="k">${k}</div>
              <div>${v}</div>
            </div>
          `).join("")}
        </div>

        <div class="footer">
          <div class="hint" id="hint">${feedback ? feedback : "è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ"}</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn secondary" id="quitBtn">é€€å‡º</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">å½“å‰æˆ˜ç»©</div>
        <div class="smallnote" style="margin-top:10px">
          æ­£ç¡®ï¼š<b>${state.correct}</b><br/>
          é”™è¯¯ï¼š<b>${state.wrong}</b><br/>
          æœ¬å…³å‰©ä½™ï¼š<b>${total - (state.qIndex + 1)}</b>
        </div>
        <div class="smallnote" style="margin-top:12px">
          è§„åˆ™ï¼šç­”å®Œæœ¬å…³å…¨éƒ¨é¢˜åç»“ç®—ï¼Œè¾¾æ ‡æ‰èƒ½è¿›å…¥ä¸‹ä¸€å…³ï¼Œä¸è¾¾æ ‡ç›´æ¥å¤±è´¥ç»“æŸã€‚
        </div>
      </div>
    </div>
  `;

            document.getElementById("quitBtn").addEventListener("click", () => {
                renderHome();
            });

            const opts = document.getElementById("opts");
            let locked = false;
            opts.querySelectorAll(".opt").forEach(el => {
                el.addEventListener("click", () => {
                    if (locked) return;
                    locked = true;
                    const chosen = el.getAttribute("data-k");
                    const correct = q.answer;

                    // æ ‡è®°å¯¹é”™
                    opts.querySelectorAll(".opt").forEach(o => {
                        const k = o.getAttribute("data-k");
                        if (k === correct) o.classList.add("correct");
                        if (k === chosen && chosen !== correct) o.classList.add("wrong");
                        o.style.pointerEvents = "none";
                    });

                    if (chosen === correct) state.correct += 1;
                    else state.wrong += 1;

                    saveState();

                    // 0.8 ç§’åè¿›å…¥ä¸‹ä¸€é¢˜æˆ–ç»“ç®—
                    setTimeout(() => {
                        nextStep();
                    }, 800);
                });
            });
        }

        /* -------------------------
           ä¸‹ä¸€æ­¥ï¼šä¸‹ä¸€é¢˜ or ç»“ç®—
        ------------------------- */
        function nextStep() {
            const sIdx = state.stageIndex;
            const qs = stageQuestions(sIdx);

            if (state.qIndex < qs.length - 1) {
                state.qIndex += 1;
                saveState();
                renderQuestion();
                return;
            }

            // æœ¬å…³ç­”å®Œï¼Œç»“ç®—
            renderStageResult();
        }

        function renderStageResult() {
            const sIdx = state.stageIndex;
            const stage = STAGES[sIdx];
            const qs = stageQuestions(sIdx);
            const minCorrect = stagePassMin(sIdx);
            const passed = state.correct >= minCorrect;

            const total = qs.length;
            const scoreLine = `${state.correct}/${total}`;

            // è®°å½•æœ¬å…³ç­”é¢˜ç»“æœ
            state.stageResults.push({
                stage: stage.name,
                stageIndex: sIdx,
                correct: state.correct,
                wrong: state.wrong,
                total: total,
                passed: passed,
                time: fmtNow()
            });

            let msg = "";
            if (passed) {
                state.medals[stageKey(sIdx)] = true;
                msg = `é€šè¿‡ï¼è·å¾—ã€${stage.medal}ã€‘`;
            } else {
                msg = "æœªè¾¾æ ‡ï¼Œæœ¬æ¬¡æŒ‘æˆ˜å¤±è´¥";
            }
            saveState();

            sub.textContent = "å…³å¡ç»“ç®—";

            view.innerHTML = `
    <div class="card">
      <div class="badgebar" style="margin-bottom:10px">
        ${badgeHTML("åˆå¿ƒç« ", state.medals.stage1)}
        ${badgeHTML("åŠ›è¡Œç« ", state.medals.stage2)}
        ${badgeHTML("ä¼ æ‰¬ç« ", state.medals.stage3)}
      </div>

      <div class="big">${stage.name}</div>
      <div class="smallnote" style="margin-top:8px">
        æˆç»©ï¼š<b>${scoreLine}</b>ï¼Œé€šå…³çº¿ï¼š<b>${minCorrect}</b>ï¼ˆç­”å¯¹é¢˜æ•°ï¼‰
      </div>

      <div class="big" style="color:${passed ? "var(--gold)" : "var(--brand)"}; margin-top:10px">${msg}</div>

      <div class="footer" style="margin-top:12px">
        <div class="hint">${passed ? (sIdx === 2 ? "æ­å–œå®Œæˆæ‰€æœ‰å…³å¡ï¼" : "ç»§ç»­æŒ‘æˆ˜ä¸‹ä¸€å…³") : "ä½ å¯ä»¥è¿”å›é¦–é¡µé‡æ–°å¼€å§‹"}</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          ${passed && sIdx === 2 ? `<button class="btn" id="claimRewardBtn">é¢†å–å¥–åŠ±</button>` : ""}
          ${passed && sIdx < 2 ? `<button class="btn" id="nextStageBtn">è¿›å…¥ä¸‹ä¸€å…³</button>` : ""}
          <button class="btn secondary" id="homeBtn">è¿”å›é¦–é¡µ</button>
          ${!passed ? `<button class="btn" id="retryBtn">é‡æ–°æŒ‘æˆ˜</button>` : ""}
        </div>
      </div>
    </div>
  `;

            document.getElementById("homeBtn").addEventListener("click", renderHome);

            const retry = document.getElementById("retryBtn");
            if (retry) {
                retry.addEventListener("click", () => {
                    // é‡å¼€æœ¬å…³
                    state.qIndex = 0;
                    state.correct = 0;
                    state.wrong = 0;
                    saveState();
                    renderQuestion();
                });
            }

            const nextBtn = document.getElementById("nextStageBtn");
            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    // è¿›å…¥ä¸‹ä¸€å…³ï¼Œé‡ç½®æœ¬å…³è®¡æ•°
                    state.stageIndex += 1;
                    state.qIndex = 0;
                    state.correct = 0;
                    state.wrong = 0;
                    saveState();
                    renderQuestion();
                });
            }

            const claimRewardBtn = document.getElementById("claimRewardBtn");
            if (claimRewardBtn) {
                claimRewardBtn.addEventListener("click", () => {
                    // è‡ªåŠ¨ä¿å­˜ç­”é¢˜ç»“æœ
                    saveQuizResult();
                    // æ˜¾ç¤ºå¥–åŠ±å›¾ç‰‡
                    showGiftImage();
                });
            }
        }

        // æ˜¾ç¤ºå¥–åŠ±å›¾ç‰‡
        function showGiftImage() {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            // åˆ›å»ºå›¾ç‰‡å®¹å™¨
            const imageContainer = document.createElement('div');
            imageContainer.style.cssText = `
                position: relative;
                max-width: 90%;
                max-height: 90%;
                animation: scaleIn 0.5s ease;
            `;

            // åˆ›å»ºå›¾ç‰‡
            const img = document.createElement('img');
            img.src = 'gift.png';
            img.alt = 'å¥–åŠ±';
            img.style.cssText = `
                width: 100%;
                height: auto;
                max-width: 600px;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            `;

            // åˆ›å»ºå…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'å…³é—­';
            closeBtn.className = 'btn';
            closeBtn.style.cssText = `
                margin-top: 20px;
                width: 100%;
                padding: 12px 24px;
                font-size: 16px;
            `;
            closeBtn.addEventListener('click', () => {
                overlay.remove();
                renderHome();
            });

            // ç»„è£…å…ƒç´ 
            imageContainer.appendChild(img);
            imageContainer.appendChild(closeBtn);
            overlay.appendChild(imageContainer);

            // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    renderHome();
                }
            });

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlay);

            // æ·»åŠ åŠ¨ç”»æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if (!document.getElementById('gift-animations')) {
                const style = document.createElement('style');
                style.id = 'gift-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes scaleIn {
                        from { transform: scale(0.8); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function renderFinishForm() {
            sub.textContent = "å®Œå…¨é€šå…³";

            // è®¡ç®—æ€»æˆç»©
            const totalCorrect = state.stageResults.reduce((sum, r) => sum + r.correct, 0);
            const totalWrong = state.stageResults.reduce((sum, r) => sum + r.wrong, 0);
            const totalQuestions = state.stageResults.reduce((sum, r) => sum + r.total, 0);

            view.innerHTML = `
    <div class="row">
      <div class="card" style="flex:1 1 520px">
        <div class="badgebar">
          ${badgeHTML("åˆå¿ƒç« ", true)}
          ${badgeHTML("åŠ›è¡Œç« ", true)}
          ${badgeHTML("ä¼ æ‰¬ç« ", true)}
        </div>
        <div class="big" style="margin-top:10px">æ­å–œå®Œå…¨é€šå…³ï¼</div>
        <div class="smallnote" style="margin-top:8px">
          <b>å­¦å·ï¼š</b>${state.studentId}<br/>
          <b>æ€»æˆç»©ï¼š</b>${totalCorrect}/${totalQuestions}ï¼ˆæ­£ç¡® ${totalCorrect} é¢˜ï¼Œé”™è¯¯ ${totalWrong} é¢˜ï¼‰
        </div>
        
        <div class="smallnote" style="margin-top:12px;padding:10px;background:rgba(0,0,0,.04);border-radius:8px">
          <b>å„å…³æˆç»©ï¼š</b><br/>
          ${state.stageResults.map(r =>
                `ç¬¬${r.stageIndex + 1}å…³ï¼š${r.correct}/${r.total}ï¼ˆ${r.passed ? 'âœ“é€šè¿‡' : 'âœ—æœªé€šè¿‡'}ï¼‰`
            ).join('<br/>')}
        </div>

        <div class="footer" style="margin-top:12px">
          <div class="hint" id="formHint">ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="homeBtn2">è¿”å›é¦–é¡µ</button>
            <button class="btn ghost" id="testSaveBtn" style="font-size:12px;padding:8px 10px">ğŸ” æµ‹è¯•ä¿å­˜</button>
          </div>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <div class="big">ç­”é¢˜ç»Ÿè®¡</div>
        <div class="smallnote" style="margin-top:10px">
          <b>å­¦å·ï¼š</b>${state.studentId}<br/>
          <b>æ€»æ­£ç¡®ï¼š</b>${totalCorrect} é¢˜<br/>
          <b>æ€»é”™è¯¯ï¼š</b>${totalWrong} é¢˜<br/>
          <b>æ€»é¢˜æ•°ï¼š</b>${totalQuestions} é¢˜<br/>
          <b>å®Œæˆæ—¶é—´ï¼š</b>${fmtNow()}
        </div>
      </div>
    </div>
  `;

            document.getElementById("homeBtn2").addEventListener("click", renderHome);

            // æµ‹è¯•ä¿å­˜æŒ‰é’®ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
            const testBtn = document.getElementById("testSaveBtn");
            if (testBtn) {
                testBtn.addEventListener("click", () => {
                    console.log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•ä¿å­˜åŠŸèƒ½...');
                    const hint = document.getElementById('formHint');
                    if (hint) {
                        hint.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•ä¿å­˜...';
                        hint.style.color = 'var(--brand)';
                    }
                    // é‡æ–°ä¿å­˜
                    saveQuizResult();
                    setTimeout(() => {
                        if (hint && hint.textContent.includes('æµ‹è¯•')) {
                            hint.textContent = 'æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰';
                        }
                    }, 2000);
                });
            }

            // è‡ªåŠ¨ä¿å­˜ç­”é¢˜ç»“æœ
            saveQuizResult();
        }

        // ä¿å­˜ç­”é¢˜ç»“æœåˆ°è®°å½•
        function saveQuizResult() {
            const totalCorrect = state.stageResults.reduce((sum, r) => sum + r.correct, 0);
            const totalWrong = state.stageResults.reduce((sum, r) => sum + r.wrong, 0);
            const totalQuestions = state.stageResults.reduce((sum, r) => sum + r.total, 0);

            const result = {
                studentId: state.studentId,
                time: fmtNow(),
                totalCorrect: totalCorrect,
                totalWrong: totalWrong,
                totalQuestions: totalQuestions,
                stageResults: state.stageResults.map(r => ({
                    stage: r.stage,
                    correct: r.correct,
                    wrong: r.wrong,
                    total: r.total,
                    passed: r.passed
                }))
            };

            state.records.unshift(result);
            saveRecords();

            // å°è¯•ä¿å­˜åˆ°çº¿ä¸Š
            saveToOnline(result);
        }

        // ä¿å­˜åˆ°çº¿ä¸Š
        async function saveToOnline(result) {
            if (!ONLINE_SAVE_CONFIG.enabled) {
                console.log('â„¹ï¸ çº¿ä¸Šä¿å­˜æœªå¯ç”¨');
                return; // æœªå¯ç”¨çº¿ä¸Šä¿å­˜
            }

            console.log('ğŸ”„ å¼€å§‹ä¿å­˜åˆ°çº¿ä¸Š...', result);

            try {
                if (ONLINE_SAVE_CONFIG.type === 'bmob' && ONLINE_SAVE_CONFIG.bmobApplicationId && ONLINE_SAVE_CONFIG.bmobRestApiKey) {
                    // ä½¿ç”¨ Bmob APIï¼ˆæ¨èï¼Œå›½å†…å¯ç”¨ï¼Œå…è´¹ï¼‰
                    console.log('ğŸ“¤ é€šè¿‡ Bmob ä¿å­˜æ•°æ®...');
                    console.log('App ID:', ONLINE_SAVE_CONFIG.bmobApplicationId.substring(0, 10) + '...');

                    // Bmob API åœ°å€ï¼ˆä½¿ç”¨æ­£ç¡®çš„åŸŸåï¼‰
                    const apiUrls = [
                        `https://api.bmobcloud.com/1/classes/QuizResults`, // æ­£ç¡®çš„ API åœ°å€
                        `https://api2.bmob.cn/1/classes/QuizResults`, // å¤‡ç”¨åœ°å€
                        `https://api.bmob.cn/1/classes/QuizResults` // å¤‡ç”¨åœ°å€
                    ];

                    let lastError = null;
                    let success = false;

                    for (const apiUrl of apiUrls) {
                        try {
                            console.log('å°è¯• API åœ°å€:', apiUrl);

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'X-Bmob-Application-Id': ONLINE_SAVE_CONFIG.bmobApplicationId,
                                    'X-Bmob-REST-API-Key': ONLINE_SAVE_CONFIG.bmobRestApiKey,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    studentId: result.studentId,
                                    totalCorrect: result.totalCorrect,
                                    totalWrong: result.totalWrong,
                                    totalQuestions: result.totalQuestions,
                                    stageResults: result.stageResults,
                                    time: result.time
                                })
                            });

                            if (response.ok) {
                                const responseData = await response.json();
                                console.log('âœ… å·²ä¿å­˜åˆ° Bmob:', responseData.objectId);
                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                const hint = document.getElementById('formHint');
                                if (hint) {
                                    hint.textContent = 'âœ… ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°çº¿ä¸Š';
                                    hint.style.color = '#2ecc71';
                                }
                                success = true;
                                break;
                            } else {
                                const errorText = await response.text();
                                console.warn('âš ï¸ API åœ°å€å¤±è´¥:', apiUrl, response.status, errorText);
                                lastError = { status: response.status, text: errorText, url: apiUrl };
                            }
                        } catch (error) {
                            console.warn('âš ï¸ è¯·æ±‚å¤±è´¥:', apiUrl, error.message);
                            lastError = { error: error.message, url: apiUrl };
                        }
                    }

                    if (!success) {
                        console.error('âŒ æ‰€æœ‰ Bmob API åœ°å€éƒ½å¤±è´¥');
                        console.error('æœ€åé”™è¯¯:', lastError);
                        console.error('ğŸ’¡ æ’æŸ¥å»ºè®®ï¼š');
                        console.error('1. æ£€æŸ¥ Bmob åº”ç”¨æ˜¯å¦æ¿€æ´»');
                        console.error('2. æ£€æŸ¥ Application ID å’Œ REST API Key æ˜¯å¦æ­£ç¡®');
                        console.error('3. æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        console.error('4. è®¿é—® Bmob æ§åˆ¶å°ç¡®è®¤åº”ç”¨çŠ¶æ€');

                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âš ï¸ ä¿å­˜åˆ°çº¿ä¸Šå¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ˆè¯·æ£€æŸ¥ Bmob é…ç½®ï¼‰';
                            hint.style.color = '#e74c3c';
                        }
                    }
                } else if (ONLINE_SAVE_CONFIG.type === 'leancloud' && ONLINE_SAVE_CONFIG.leancloudAppId && ONLINE_SAVE_CONFIG.leancloudAppKey) {
                    // ä½¿ç”¨ LeanCloud APIï¼ˆå·²åœæ­¢æ³¨å†Œæ–°è´¦å·ï¼‰
                    console.log('ğŸ“¤ é€šè¿‡ LeanCloud ä¿å­˜æ•°æ®...');

                    // ç”ŸæˆæœåŠ¡å™¨åœ°å€ï¼ˆå¦‚æœæœªæä¾›ï¼‰
                    let serverUrl = ONLINE_SAVE_CONFIG.leancloudServerUrl;
                    if (!serverUrl && ONLINE_SAVE_CONFIG.leancloudAppId) {
                        // ä» App ID ç”ŸæˆæœåŠ¡å™¨åœ°å€
                        const appIdPrefix = ONLINE_SAVE_CONFIG.leancloudAppId.substring(0, 8);
                        serverUrl = `https://${appIdPrefix}.api.lncld.net`;
                    }

                    const apiUrl = `${serverUrl}/1.1/classes/QuizResults`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'X-LC-Id': ONLINE_SAVE_CONFIG.leancloudAppId,
                            'X-LC-Key': ONLINE_SAVE_CONFIG.leancloudAppKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            studentId: result.studentId,
                            totalCorrect: result.totalCorrect,
                            totalWrong: result.totalWrong,
                            totalQuestions: result.totalQuestions,
                            stageResults: result.stageResults,
                            time: result.time
                        })
                    });

                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('âœ… å·²ä¿å­˜åˆ° LeanCloud:', responseData.objectId);
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âœ… ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°çº¿ä¸Š';
                            hint.style.color = '#2ecc71';
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ ä¿å­˜åˆ° LeanCloud å¤±è´¥:', response.status, errorText);
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âš ï¸ ä¿å­˜åˆ°çº¿ä¸Šå¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°æœ¬åœ°';
                            hint.style.color = '#e74c3c';
                        }
                    }
                } else if (ONLINE_SAVE_CONFIG.type === 'gist' && ONLINE_SAVE_CONFIG.gistToken && ONLINE_SAVE_CONFIG.gistId) {
                    // ä½¿ç”¨ GitHub Gist API
                    const allResults = state.records;
                    const content = JSON.stringify(allResults, null, 2);
                    console.log('ğŸ“¤ å‡†å¤‡ä¸Šä¼ æ•°æ®ï¼Œå…±', allResults.length, 'æ¡è®°å½•');

                    // GitHub API è®¤è¯ï¼šå°è¯•ä¸¤ç§æ–¹å¼
                    // 1. Bearer æ–¹å¼ï¼ˆæ¨èï¼Œé€‚ç”¨äºæ‰€æœ‰ token ç±»å‹ï¼‰
                    // 2. token å‰ç¼€ï¼ˆæ—§ç‰ˆ classic tokenï¼‰
                    const token = ONLINE_SAVE_CONFIG.gistToken.trim(); // å»é™¤å¯èƒ½çš„ç©ºæ ¼

                    // å…ˆå°è¯• Bearer æ–¹å¼
                    let authHeader = `Bearer ${token}`;

                    const response = await fetch(`https://api.github.com/gists/${ONLINE_SAVE_CONFIG.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': authHeader,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify({
                            files: {
                                'quiz_results.json': {
                                    content: content
                                }
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… å·²ä¿å­˜åˆ° GitHub Gist:', data.html_url);
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âœ… ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°çº¿ä¸Š';
                            hint.style.color = '#2ecc71';
                        }
                    } else {
                        const errorText = await response.text();
                        let errorMsg = '';
                        let errorDetail = '';

                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg = errorJson.message || 'æœªçŸ¥é”™è¯¯';
                            errorDetail = errorJson.documentation_url ? `\næ–‡æ¡£: ${errorJson.documentation_url}` : '';
                        } catch {
                            errorMsg = errorText;
                        }

                        console.error('âŒ ä¿å­˜åˆ° Gist å¤±è´¥:', response.status, errorMsg);
                        console.error('è¯¦ç»†é”™è¯¯:', errorText);

                        // å¦‚æœæ˜¯ 401 é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯
                        if (response.status === 401) {
                            console.error('ğŸ” 401 é”™è¯¯æ’æŸ¥ï¼š');
                            console.error('1. æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®ï¼ˆæ˜¯å¦æœ‰ç©ºæ ¼æˆ–æˆªæ–­ï¼‰');
                            console.error('2. æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ');
                            console.error('3. æ£€æŸ¥ Token æ˜¯å¦æœ‰ gist æƒé™');
                            console.error('4. è®¿é—® https://github.com/settings/tokens é‡æ–°ç”Ÿæˆ Token');

                            // å°è¯•ä½¿ç”¨ token å‰ç¼€æ–¹å¼ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
                            console.log('ğŸ”„ å°è¯•ä½¿ç”¨ token å‰ç¼€æ–¹å¼...');
                            try {
                                const retryResponse = await fetch(`https://api.github.com/gists/${ONLINE_SAVE_CONFIG.gistId}`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Authorization': `token ${token}`, // æ—§ç‰ˆæ–¹å¼
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/vnd.github.v3+json'
                                    },
                                    body: JSON.stringify({
                                        files: {
                                            'quiz_results.json': {
                                                content: content
                                            }
                                        }
                                    })
                                });

                                if (retryResponse.ok) {
                                    const data = await retryResponse.json();
                                    console.log('âœ… ä½¿ç”¨ token å‰ç¼€æ–¹å¼ä¿å­˜æˆåŠŸ:', data.html_url);
                                    const hint = document.getElementById('formHint');
                                    if (hint) {
                                        hint.textContent = 'âœ… ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°çº¿ä¸Š';
                                        hint.style.color = '#2ecc71';
                                    }
                                    return; // æˆåŠŸï¼Œé€€å‡º
                                } else {
                                    console.error('âŒ token å‰ç¼€æ–¹å¼ä¹Ÿå¤±è´¥:', await retryResponse.text());
                                }
                            } catch (retryError) {
                                console.error('âŒ é‡è¯•å¤±è´¥:', retryError);
                            }
                        }

                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            if (response.status === 401) {
                                hint.textContent = 'âš ï¸ è®¤è¯å¤±è´¥ï¼šè¯·æ£€æŸ¥ Token æ˜¯å¦æ­£ç¡®æˆ–å·²è¿‡æœŸ';
                            } else {
                                hint.textContent = `âš ï¸ ä¿å­˜å¤±è´¥ï¼ˆ${response.status}ï¼‰ï¼Œä½†å·²ä¿å­˜åˆ°æœ¬åœ°`;
                            }
                            hint.style.color = '#e74c3c';
                        }
                    }
                } else if (ONLINE_SAVE_CONFIG.type === 'webhook' && ONLINE_SAVE_CONFIG.webhookUrl) {
                    // ä½¿ç”¨ Webhookï¼ˆå¦‚ Google Apps Scriptï¼‰- æ¨èæ–¹æ¡ˆï¼ŒToken ä¸ä¼šæ³„éœ²
                    console.log('ğŸ“¤ é€šè¿‡ Webhook ä¿å­˜æ•°æ®...');
                    const response = await fetch(ONLINE_SAVE_CONFIG.webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            studentId: result.studentId,
                            totalCorrect: result.totalCorrect,
                            totalWrong: result.totalWrong,
                            totalQuestions: result.totalQuestions,
                            stageResults: result.stageResults,
                            time: result.time
                        })
                    });

                    if (response.ok) {
                        const responseData = await response.json().catch(() => ({ message: 'æˆåŠŸ' }));
                        console.log('âœ… å·²ä¿å­˜åˆ°çº¿ä¸Š:', responseData.message || 'æˆåŠŸ');
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âœ… ç­”é¢˜ç»“æœå·²è‡ªåŠ¨ä¿å­˜åˆ°çº¿ä¸Š';
                            hint.style.color = '#2ecc71';
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('âŒ ä¿å­˜åˆ° Webhook å¤±è´¥:', response.status, errorText);
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        const hint = document.getElementById('formHint');
                        if (hint) {
                            hint.textContent = 'âš ï¸ ä¿å­˜åˆ°çº¿ä¸Šå¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°æœ¬åœ°';
                            hint.style.color = '#e74c3c';
                        }
                    }
                }
            } catch (e) {
                console.error('ä¿å­˜åˆ°çº¿ä¸Šå¤±è´¥:', e);
                // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
            }
        }

        function renderRecords() {
            sub.textContent = "ç­”é¢˜ç»Ÿè®¡ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰";
            const rows = state.records.slice(0, 200).map((r, idx) => {
                if (r.studentId) {
                    // æ–°æ ¼å¼ï¼šåŒ…å«å­¦å·å’Œç­”é¢˜ç»“æœ
                    const stageInfo = r.stageResults ? r.stageResults.map(sr =>
                        `${sr.stage}: ${sr.correct}/${sr.total}`
                    ).join('; ') : 'æ— ';
                    return `
    <tr>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${idx + 1}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.studentId}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.totalCorrect}/${r.totalQuestions}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${stageInfo}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.time}</td>
    </tr>
  `;
                } else {
                    // æ—§æ ¼å¼ï¼šå…¼å®¹æ—§æ•°æ®
                    return `
    <tr>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${idx + 1}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.name || 'æœªçŸ¥'}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.phone || 'æœªçŸ¥'}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">-</td>
      <td style="padding:8px;border-bottom:1px solid rgba(0,0,0,.08)">${r.time}</td>
    </tr>
  `;
                }
            }).join("");

            view.innerHTML = `
    <div class="card">
      <div class="big">ç­”é¢˜ç»Ÿè®¡è®°å½•ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰</div>
      <div class="smallnote">æ¡æ•°ï¼š${state.records.length}ï¼ˆæœ€å¤šé¢„è§ˆ 200 æ¡ï¼‰</div>

      <div style="overflow:auto;margin-top:10px;border:1px solid rgba(0,0,0,.10);border-radius:12px">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="background:rgba(0,0,0,.04)">
              <th style="padding:8px;text-align:left">åºå·</th>
              <th style="padding:8px;text-align:left">å­¦å·</th>
              <th style="padding:8px;text-align:left">æ€»æˆç»©</th>
              <th style="padding:8px;text-align:left">å„å…³æˆç»©</th>
              <th style="padding:8px;text-align:left">å®Œæˆæ—¶é—´</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="5" style="padding:10px">æš‚æ— è®°å½•</td></tr>`}</tbody>
        </table>
      </div>

      <div class="footer">
        <div class="hint">å¼€å‘è€…ä¸“ç”¨ï¼šå¯¼å‡º CSV ç”¨äºç»Ÿè®¡åˆ†æ</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn secondary" id="exportBtn2">å¯¼å‡º CSV</button>
          <button class="btn" id="homeBtn3">è¿”å›é¦–é¡µ</button>
        </div>
      </div>
    </div>
  `;

            document.getElementById("exportBtn2").addEventListener("click", exportCSV);
            document.getElementById("homeBtn3").addEventListener("click", renderHome);
        }

        function exportCSV() {
            const header = ["å­¦å·", "æ€»æ­£ç¡®", "æ€»é”™è¯¯", "æ€»é¢˜æ•°", "ç¬¬ä¸€å…³æˆç»©", "ç¬¬äºŒå…³æˆç»©", "ç¬¬ä¸‰å…³æˆç»©", "å®Œæˆæ—¶é—´"];
            const lines = [header.join(",")].concat(
                state.records.map(r => {
                    if (r.studentId) {
                        // æ–°æ ¼å¼
                        const stage1 = r.stageResults && r.stageResults[0] ? `${r.stageResults[0].correct}/${r.stageResults[0].total}` : '-';
                        const stage2 = r.stageResults && r.stageResults[1] ? `${r.stageResults[1].correct}/${r.stageResults[1].total}` : '-';
                        const stage3 = r.stageResults && r.stageResults[2] ? `${r.stageResults[2].correct}/${r.stageResults[2].total}` : '-';
                        return [
                            r.studentId,
                            r.totalCorrect || 0,
                            r.totalWrong || 0,
                            r.totalQuestions || 0,
                            stage1,
                            stage2,
                            stage3,
                            r.time
                        ].map(escapeCSV).join(",");
                    } else {
                        // æ—§æ ¼å¼å…¼å®¹
                        return [
                            r.name || '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            '',
                            r.time
                        ].map(escapeCSV).join(",");
                    }
                })
            );
            const blob = new Blob(["\ufeff" + lines.join("\n")], { type: "text/csv;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "ç­”é¢˜ç»Ÿè®¡_" + new Date().toISOString().slice(0, 10) + ".csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        /* -------------------------
           å¼€å‘è€…æ¨¡å¼ï¼šé€šè¿‡ç‰¹æ®ŠæŒ‰é”®ç»„åˆè¿›å…¥
        ------------------------- */
        let devKeySequence = [];
        document.addEventListener('keydown', (e) => {
            devKeySequence.push(e.key);
            if (devKeySequence.length > 5) devKeySequence.shift();
            // æŒ‰é¡ºåºæŒ‰ä¸‹ï¼šd-e-v
            if (devKeySequence.slice(-3).join('') === 'dev') {
                // æ˜¾ç¤ºå¼€å‘è€…å…¥å£
                const topbar = document.querySelector('.topbar .controls');
                if (topbar && !document.getElementById('devRecordsBtn')) {
                    const devBtn = document.createElement('button');
                    devBtn.className = 'btn ghost';
                    devBtn.id = 'devRecordsBtn';
                    devBtn.textContent = 'ğŸ“Š ç»Ÿè®¡';
                    devBtn.style.fontSize = '12px';
                    devBtn.addEventListener('click', renderRecords);
                    topbar.insertBefore(devBtn, topbar.firstChild);
                    devKeySequence = [];
                }
            }
        });

        /* -------------------------
           å¯åŠ¨
        ------------------------- */
        updateMusicBtn();
        renderHome();
    </script>
</body>

</html>